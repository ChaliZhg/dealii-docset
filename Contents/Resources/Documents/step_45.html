<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-45 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2017 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-45 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a>
        <li><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br />
</p>
<p><em>This program was contributed by Daniel Arndt and Matthias Maier.</em> <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>In this example we present how to use periodic boundary conditions in deal.II. Periodic boundary conditions are algebraic constraints that typically occur in computations on representative regions of a larger domain that repeat in one or more directions.</p>
<p>An example is the simulation of the electronic structure of photonic crystals, because they have a lattice-like structure and, thus, it often suffices to do the actual computation on only one box of the lattice. To be able to proceed this way one has to assume that the computation can be periodically extended to the other boxes; this requires the solution to have a periodic structure.</p>
<p><a class="anchor" id="Procedure"></a> <a class="anchor" id="Procedure"></a></p><h1>Procedure</h1>
<p>deal.II provides a number of high level entry points to impose periodic boundary conditions. The general approach to apply periodic boundary conditions consists of three steps (see also the <a class="el" href="DEALGlossary.html#GlossPeriodicConstraints">Glossary entry on periodic boundary conditions</a>):</p><ol type="1">
<li>Create a mesh</li>
<li>Identify those pairs of faces on different parts of the boundary across which the solution should be symmetric, using <a class="el" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces()</a></li>
<li>Add the periodicity information to the mesh using <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#a9539cda687eeb08c602bceac11807987">parallel::distributed::Triangulation::add_periodicity()</a></li>
<li>Add periodicity constraints using <a class="el" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints()</a></li>
</ol>
<p>The second and third step are necessary for distributed meshes to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. If the <a class="el" href="classTriangulation.html">Triangulation</a> is not a <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a>, these steps have to be omitted.</p>
<p>The first step consists of collecting matching periodic faces and storing them in a <code>std::vector</code> of <a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>. This is done with the function <a class="el" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces()</a> that can be invoked for example like this: </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  b_id1,</div><div class="line">                                  b_id2,</div><div class="line">                                  direction,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  offset = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  matrix = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  first_vector_components = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p>This call loops over all faces of the container dof_handler on the opposing boundaries with boundary indicator <code>b_id1</code> and <code>b_id2</code>, respecitvely. If <img class="formulaInl" alt="$\text{vertices}_{1/2}$" src="form_3790.png"/> are the vertices of <img class="formulaInl" alt="$\text{face}_{1/2}$" src="form_3791.png"/>, it matches pairs of faces (and dofs) such that the difference between <img class="formulaInl" alt="$\text{vertices}_2$" src="form_3792.png"/> and <img class="formulaInl" alt="$matrix\cdot \text{vertices}_1+\text{offset}$" src="form_3793.png"/> vanishes in every component apart from direction and stores the resulting pairs with associated data in <code>matched_pairs</code>. (See <a class="el" href="namespaceGridTools.html#ac2a1903382c6cff07b33d456a641f6d9">GridTools::orthogonal_equality()</a> for detailed information about the matching process.)</p>
<p>Consider, for example, the colored unit square <img class="formulaInl" alt="$\Omega=[0,1]^2$" src="form_1448.png"/> with boundary indicator 0 on the left, 1 on the right, 2 on the bottom and 3 on the top faces. Then, </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs);</div></div><!-- fragment --><p> would yield periodicity constraints such that <img class="formulaInl" alt="$u(0,y)=u(1,y)$" src="form_3794.png"/> for all <img class="formulaInl" alt="$y\in[0,1]$" src="form_3795.png"/>.</p>
<p>If we instead consider the parallelogram given by the convex hull of <img class="formulaInl" alt="$(0,0)$" src="form_251.png"/>, <img class="formulaInl" alt="$(1,1)$" src="form_1879.png"/>, <img class="formulaInl" alt="$(1,2)$" src="form_3134.png"/>, <img class="formulaInl" alt="$(0,1)$" src="form_247.png"/> we can achieve the constraints <img class="formulaInl" alt="$u(0,y)=u(1,y+1)$" src="form_837.png"/> by specifying an <code>offset:</code> </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(0.,1.));</div></div><!-- fragment --><p> or </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*arbitrary direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(1.,1.));</div></div><!-- fragment --><p>The resulting <code>matched_pairs</code> can be used in <a class="el" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints</a> for populating a <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> with periodicity constraints: </p><div class="fragment"><div class="line"><a class="code" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints</a>(matched_pairs, constraints);</div></div><!-- fragment --><p>Apart from this high level interface there are also variants of <a class="el" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints</a> available that combine those two steps (see the variants of DofTools::make_periodicity_constraints).</p>
<p>There is also a low level interface to <a class="el" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints</a> if more flexibility is needed. The low level variant allows to directly specify two faces that shall be constrained: </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceDoFTools.html">DoFTools</a>;</div><div class="line"><a class="code" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">make_periodicity_constraints</a>(face_1,</div><div class="line">                             face_2,</div><div class="line">                             constraint_matrix,</div><div class="line">                             component_mask = &lt;<span class="keywordflow">default</span> value&gt;;</div><div class="line">                             face_orientation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_flip = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_rotation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             matrix = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p> Here, we need to specify the orientation of the two faces using <code>face_orientation</code>, <code>face_flip</code> and <code>face_orientation</code>. For a closer description have a look at the documentation of <a class="el" href="namespaceDoFTools.html#ab1028908d67f767237a12fce8e761c16">DoFTools::make_periodicity_constraints</a>. The remaining parameters are the same as for the high level interface apart from the self-explaining <code>component_mask</code> and <code>constraint_matrix</code>.</p>
<p><a class="anchor" id="problem"></a> <a class="anchor" id="Apracticalexample"></a></p><h1>A practical example</h1>
<p>In the following, we show how to use the above functions in a more involved example. The task is to enforce rotated periodicity constraints for the velocity component of a Stokes flow.</p>
<p>On a quarter-circle defined by <img class="formulaInl" alt="$\Omega=\{{\bf x}\in(0,1)^2:\|{\bf x}\|\in (0.5,1)\}$" src="form_3796.png"/> we are going to solve the Stokes problem </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} -\Delta \; \textbf{u} + \nabla p &amp;=&amp; (\exp(-100*\|{\bf x}-(.75,0.1)^T\|^2),0)^T, \\ -\textrm{div}\; \textbf{u}&amp;=&amp;0,\\ \textbf{u}|_{\Gamma_1}&amp;=&amp;{\bf 0}, \end{eqnarray*}" src="form_3797.png"/>
</p>
<p> where the boundary <img class="formulaInl" alt="$\Gamma_1$" src="form_2405.png"/> is defined as <img class="formulaInl" alt="$\Gamma_1:=\{x\in \partial\Omega: \|x\|\in\{0.5,1\}\}$" src="form_3798.png"/>. For the remaining parts of the boundary we are going to use periodic boundary conditions, i.e. </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} u_x(0,\nu)&amp;=-u_y(\nu,0)&amp;\nu&amp;\in[0,1]\\ u_y(0,\nu)&amp;=u_x(\nu,0)&amp;\nu&amp;\in[0,1]. \end{align*}" src="form_3799.png"/>
</p>
<p> <a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>This example program is a slight modification of <a class="el" href="step_22.html">step-22</a> running in parallel using Trilinos to demonstrate the usage of periodic boundary conditions in deal.II. We thus omit to discuss the majority of the source code and only comment on the parts that deal with periodicity constraints. For the rest have a look at <a class="el" href="step_22.html">step-22</a> and the full source code at the bottom.</p>
<p>In order to implement periodic boundary conditions only two functions have to be modified:</p><ul>
<li><code>StokesProblem&lt;dim&gt;::setup_dofs()</code>: To populate a <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> object with periodicity constraints</li>
<li><code>StokesProblem&lt;dim&gt;::run()</code>: To supply a distributed triangulation with periodicity information.</li>
</ul>
<p><a class="anchor" id="Settingupperiodicityconstraintsondistributedtriangulations"></a> </p><h3>Setting up periodicity constraints on distributed triangulations</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">{</div><div class="line">  <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> center;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a> (triangulation,</div><div class="line">                                      center,</div><div class="line">                                      inner_radius,</div><div class="line">                                      outer_radius,</div><div class="line">                                      0,</div><div class="line">                                      <span class="keyword">true</span>);</div></div><!-- fragment --><p>Before we can prescribe periodicity constraints, we need to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. At this point we need to think about how we want to prescribe periodicity. The vertices <img class="formulaInl" alt="$\text{vertices}_2$" src="form_3792.png"/> of a face on the left boundary should be matched to the vertices <img class="formulaInl" alt="$\text{vertices}_1$" src="form_3800.png"/> of a face on the lower boundary given by <img class="formulaInl" alt="$\text{vertices}_2=R\cdot \text{vertices}_1+b$" src="form_3801.png"/> where the rotation matrix <img class="formulaInl" alt="$R$" src="form_432.png"/> and the offset <img class="formulaInl" alt="$b$" src="form_41.png"/> are given by </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}" src="form_3802.png"/>
</p>
<p> The data structure we are saving the reuslitng information into is here based on the <a class="el" href="classTriangulation.html">Triangulation</a>.</p>
<div class="fragment"><div class="line">std::vector&lt;GridTools::PeriodicFacePair&lt;typename parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator&gt; &gt;</div><div class="line">periodicity_vector;</div><div class="line"></div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1]=1.;</div><div class="line">rotation_matrix[1][0]=-1.;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(triangulation, 2, 3, 1,</div><div class="line">                                  periodicity_vector, <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Now telling the triangulation about the desired periodicity is particularly easy by just calling <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#a9539cda687eeb08c602bceac11807987">parallel::distributed::Triangulation::add_periodicity</a>.</p>
<div class="fragment"><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a9539cda687eeb08c602bceac11807987">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="group__boundary.html#ga19accbef5edb5bb16a926d3db659cd5c">set_boundary</a>(0, boundary);</div><div class="line">  triangulation.<a class="code" href="group__boundary.html#ga19accbef5edb5bb16a926d3db659cd5c">set_boundary</a>(1, boundary);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (4-dim);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Settingupperiodicityconstraintsondistributedtriangulations"></a> </p><h3>Setting up periodicity constraints on distributed triangulations</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs ()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a> (fe);</div><div class="line"></div><div class="line">  std::vector&lt;unsigned int&gt; block_component (dim+1,0);</div><div class="line">  block_component[dim] = 1;</div><div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> (dof_handler, block_component);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; dofs_per_block (2);</div><div class="line">  <a class="code" href="namespaceDoFTools.html#abfd9796e22113e13b5802e384e56af4f">DoFTools::count_dofs_per_block</a> (dof_handler, dofs_per_block, block_component);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0],</div><div class="line">                     n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">  {</div><div class="line">    owned_partitioning.clear();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u+n_p));</div><div class="line"></div><div class="line">    relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#af0eef74bf66f0bfa8847f66fe6c8908d">DoFTools::extract_locally_relevant_dofs</a> (dof_handler, locally_relevant_dofs);</div><div class="line">    relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u+n_p));</div><div class="line"></div><div class="line">    constraints.<a class="code" href="classConstraintMatrix.html#a24120d0331183f9a63cbe41493a19f6b">clear</a> ();</div><div class="line">    constraints.<a class="code" href="classConstraintMatrix.html#ac2726821354883ac97fe7e6181de9792">reinit</a>(locally_relevant_dofs);</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#ga3eaa31a679484e80c193e74e8a967dc8">DoFTools::make_hanging_node_constraints</a> (dof_handler,</div><div class="line">                                             constraints);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                              dof_handler,</div><div class="line">                                              0,</div><div class="line">                                              BoundaryValues&lt;dim&gt;(),</div><div class="line">                                              constraints,</div><div class="line">                                              fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                              dof_handler,</div><div class="line">                                              1,</div><div class="line">                                              BoundaryValues&lt;dim&gt;(),</div><div class="line">                                              constraints,</div><div class="line">                                              fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div></div><!-- fragment --><p>After we provided the mesh with the necessary information for the periodicity constraints, we are now able to actual create them. For describing the matching we are using the same approach as before, i.e., the <img class="formulaInl" alt="$\text{vertices}_2$" src="form_3792.png"/> of a face on the left boundary should be matched to the vertices <img class="formulaInl" alt="$\text{vertices}_1$" src="form_3800.png"/> of a face on the lower boundary given by <img class="formulaInl" alt="$\text{vertices}_2=R\cdot \text{vertices}_1+b$" src="form_3801.png"/> where the rotation matrix <img class="formulaInl" alt="$R$" src="form_432.png"/> and the offset <img class="formulaInl" alt="$b$" src="form_41.png"/> are given by </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}" src="form_3802.png"/>
</p>
<p> These two objects not only describe how faces should be matched but also in which sense the solution should be transformed from <img class="formulaInl" alt="$\text{face}_2$" src="form_3803.png"/> to <img class="formulaInl" alt="$\text{face}_1$" src="form_3804.png"/>.</p>
<div class="fragment"><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1]=1.;</div><div class="line">rotation_matrix[1][0]=-1.;</div><div class="line"></div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1,dim&gt;</a> offset;</div></div><!-- fragment --><p>For setting up the constraints, we first store the periodicity information in an auxiliary object of type <code>std::vector&lt;<a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;typename <a class="el" href="classDoFHandler.html">DoFHandler</a>&lt;dim&gt;::cell_iterator&gt; </code>. The periodic boundaries have the boundary indicators 2 (x=0) and 3 (y=0). All the other parameters we have set up before. In this case the direction does not matter. Due to <img class="formulaInl" alt="$\text{vertices}_2=R\cdot \text{vertices}_1+b$" src="form_3801.png"/> this is exactly what we want.</p>
<div class="fragment"><div class="line">std::vector&lt;GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator&gt; &gt;</div><div class="line">periodicity_vector;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler, 2, 3, direction,</div><div class="line">                                  periodicity_vector, offset,</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Next we need to provide information on which vector valued components of the solution should be rotated. Since we choose here to just constraint the velocity and this starts at the first component of the solution vector we simply insert a 0:</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">first_vector_components.push_back(0);</div></div><!-- fragment --><p>After setting up all the information in periodicity_vector all we have to do is to tell make_periodicity_constraints to create the desired constraints.</p>
<div class="fragment"><div class="line">    DoFTools::make_periodicity_constraints&lt;DoFHandler&lt;dim&gt; &gt;</div><div class="line">    (periodicity_vector, constraints, fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities),</div><div class="line">     first_vector_components);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                              dof_handler,</div><div class="line">                                              0,</div><div class="line">                                              BoundaryValues&lt;dim&gt;(),</div><div class="line">                                              constraints,</div><div class="line">                                              fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                              dof_handler,</div><div class="line">                                              1,</div><div class="line">                                              BoundaryValues&lt;dim&gt;(),</div><div class="line">                                              constraints,</div><div class="line">                                              fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">  }</div><div class="line"></div><div class="line">  constraints.close ();</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp</div><div class="line">    (owned_partitioning, owned_partitioning,</div><div class="line">     relevant_partitioning, mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#ga38d88a1a559e9fc65d60f3e168921ba5">DoFTools::make_sparsity_pattern</a></div><div class="line">    (dof_handler, bsp, constraints, <span class="keyword">false</span>,</div><div class="line">     <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(mpi_communicator));</div><div class="line"></div><div class="line">    bsp.compress();</div><div class="line"></div><div class="line">    system_matrix.reinit (bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a> (owned_partitioning,</div><div class="line">                     mpi_communicator);</div><div class="line">  solution.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a> (owned_partitioning, relevant_partitioning,</div><div class="line">                   mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>The created output is not very surprising. We simply see that the solution is periodic with respect to the left and lower boundary:</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.periodic.png"/>
</div>
<p>Without the periodicity constraints we would have ended up with the following solution:</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.non_periodic.png"/>
</div>
<p> <a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2008 - 2017 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE at</span></div><div class="line"><span class="comment"> * the top level of the deal.II distribution.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Daniel Arndt, Matthias Maier, 2015</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Based on @ref step_22 &quot;step-22&quot; by Wolfgang Bangerth and Martin Kronbichler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/conditional_ostream.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/distributed/grid_refinement.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_solver.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_precondition.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_block_sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_parallel_block_vector.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/block_sparsity_pattern.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_generator.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_tools.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_renumbering.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_system.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/mapping_q.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/error_estimator.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step45</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree);</div><div class="line">    <span class="keywordtype">void</span> run ();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> create_mesh();</div><div class="line">    <span class="keywordtype">void</span> setup_dofs ();</div><div class="line">    <span class="keywordtype">void</span> assemble_system ();</div><div class="line">    <span class="keywordtype">void</span> solve ();</div><div class="line">    <span class="keywordtype">void</span> output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">void</span> refine_mesh ();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   degree;</div><div class="line"></div><div class="line">    MPI_Comm                                    mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classHyperShellBoundary.html">HyperShellBoundary&lt;dim&gt;</a>                     boundary;</div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a>   triangulation;</div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                               fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                             dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                            constraints;</div><div class="line">    std::vector&lt;IndexSet&gt;                       owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt;                       relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a>      sparsity_pattern;</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a>         system_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>          solution;</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>          system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a>                          pcout;</div><div class="line"></div><div class="line">    <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a>                               mapping;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BoundaryValues () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim+1) {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                               <a class="code" href="classVector.html">Vector&lt;double&gt;</a>   &amp;value) <span class="keyword">const</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span></div><div class="line">  BoundaryValues&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>  &amp;<span class="comment">/*p*/</span>,</div><div class="line">                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    (void) component;</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component &lt; this-&gt;n_components,</div><div class="line">            <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a> (component, 0, this-&gt;n_components));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  BoundaryValues&lt;dim&gt;::vector_value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                     <a class="code" href="classVector.html">Vector&lt;double&gt;</a>   &amp;values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c=0; c&lt;this-&gt;n_components; ++c)</div><div class="line">      values(c) = BoundaryValues&lt;dim&gt;::value (p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim+1) {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                               <a class="code" href="classVector.html">Vector&lt;double&gt;</a>   &amp;value) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span></div><div class="line">  RightHandSide&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>  &amp;p,</div><div class="line">                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> center(0.75, 0.1);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> r = (p-center).norm();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (component==0)</div><div class="line">      <span class="keywordflow">return</span> std::exp(-100.*r*r);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  RightHandSide&lt;dim&gt;::vector_value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>   &amp;values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c=0; c&lt;this-&gt;n_components; ++c)</div><div class="line">      values(c) = RightHandSide&lt;dim&gt;::value (p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InverseMatrix (<span class="keyword">const</span> MatrixType         &amp;m,</div><div class="line">                   <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">                   <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a>           &amp;locally_owned,</div><div class="line">                   <span class="keyword">const</span> MPI_Comm           &amp;mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult (<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>       &amp;dst,</div><div class="line">                <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> matrix;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> preconditioner;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> MPI_Comm *mpi_communicator;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  InverseMatrix&lt;MatrixType,PreconditionerType&gt;::InverseMatrix</div><div class="line">  (<span class="keyword">const</span> MatrixType         &amp;m,</div><div class="line">   <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a>           &amp;locally_owned,</div><div class="line">   <span class="keyword">const</span> MPI_Comm           &amp;mpi_communicator)</div><div class="line">    :</div><div class="line">    matrix (&amp;m),</div><div class="line">    preconditioner (&amp;preconditioner),</div><div class="line">    mpi_communicator (&amp;mpi_communicator),</div><div class="line">    tmp(locally_owned, mpi_communicator)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> InverseMatrix&lt;MatrixType,PreconditionerType&gt;::vmult</div><div class="line">  (<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>       &amp;dst,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control (src.<a class="code" href="classTrilinosWrappers_1_1VectorBase.html#abf1421453bd5801e0a712ceceeac3cbc">size</a>(), 1e-6*src.<a class="code" href="classTrilinosWrappers_1_1VectorBase.html#a5675065e8d08f86303fa4b1750d14291">l2_norm</a>());</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a>    cg (solver_control,</div><div class="line">                                      <a class="code" href="structTrilinosWrappers_1_1SolverCG_1_1AdditionalData.html">TrilinosWrappers::SolverCG::AdditionalData</a>());</div><div class="line"></div><div class="line">    tmp = 0.;</div><div class="line">    cg.solve (*matrix, tmp, src, *preconditioner);</div><div class="line">    dst = tmp;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> TrilinosWrappers::SparseMatrix</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    SchurComplement (<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">                     <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                     PreconditionerType&gt;                       &amp;A_inverse,</div><div class="line">                     <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a>                            &amp;owned_pres,</div><div class="line">                     <span class="keyword">const</span> MPI_Comm                            &amp;mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult (<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>       &amp;dst,</div><div class="line">                <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a> system_matrix;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">          PreconditionerType&gt; &gt; A_inverse;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp1, tmp2;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  SchurComplement&lt;PreconditionerType&gt;::</div><div class="line">  SchurComplement (<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">                   <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                   PreconditionerType&gt;                       &amp;A_inverse,</div><div class="line">                   <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a>                            &amp;owned_vel,</div><div class="line">                   <span class="keyword">const</span> MPI_Comm                            &amp;mpi_communicator)</div><div class="line">    :</div><div class="line">    system_matrix (&amp;system_matrix),</div><div class="line">    A_inverse (&amp;A_inverse),</div><div class="line">    tmp1 (owned_vel, mpi_communicator),</div><div class="line">    tmp2 (tmp1)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> SchurComplement&lt;PreconditionerType&gt;::vmult</div><div class="line">  (<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>       &amp;dst,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    system_matrix-&gt;<a class="code" href="classBlockMatrixBase.html#a1e54eb8c095bf2191a29c36a7784a5b6">block</a>(0,1).<a class="code" href="classSparseMatrix.html#a7706b5f721efc5ea1966f5a5cdaad0e6">vmult</a> (tmp1, src);</div><div class="line">    A_inverse-&gt;vmult (tmp2, tmp1);</div><div class="line">    system_matrix-&gt;block(1,0).vmult (dst, tmp2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree)</div><div class="line">    :</div><div class="line">    degree (degree),</div><div class="line">    mpi_communicator (MPI_COMM_WORLD),</div><div class="line">    triangulation (mpi_communicator),</div><div class="line">    fe (<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree+1), dim,</div><div class="line">        <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree)  , 1),</div><div class="line">    dof_handler (triangulation),</div><div class="line">    pcout (<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">           <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0),</div><div class="line">    mapping(degree+1)</div><div class="line">  {}</div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">  {</div><div class="line">    <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> center;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a> (triangulation,</div><div class="line">                                        center,</div><div class="line">                                        inner_radius,</div><div class="line">                                        outer_radius,</div><div class="line">                                        0,</div><div class="line">                                        <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    std::vector&lt;GridTools::PeriodicFacePair&lt;typename parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator&gt; &gt;</div><div class="line">    periodicity_vector;</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">    rotation_matrix[0][1]=1.;</div><div class="line">    rotation_matrix[1][0]=-1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(triangulation, 2, 3, 1,</div><div class="line">                                      periodicity_vector, <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                      rotation_matrix);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a9539cda687eeb08c602bceac11807987">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="group__boundary.html#ga19accbef5edb5bb16a926d3db659cd5c">set_boundary</a>(0, boundary);</div><div class="line">    triangulation.<a class="code" href="group__boundary.html#ga19accbef5edb5bb16a926d3db659cd5c">set_boundary</a>(1, boundary);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (4-dim);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs ()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a> (fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; block_component (dim+1,0);</div><div class="line">    block_component[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> (dof_handler, block_component);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; dofs_per_block (2);</div><div class="line">    <a class="code" href="namespaceDoFTools.html#abfd9796e22113e13b5802e384e56af4f">DoFTools::count_dofs_per_block</a> (dof_handler, dofs_per_block, block_component);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0],</div><div class="line">                       n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    {</div><div class="line">      owned_partitioning.clear();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u+n_p));</div><div class="line"></div><div class="line">      relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">      <a class="code" href="namespaceDoFTools.html#af0eef74bf66f0bfa8847f66fe6c8908d">DoFTools::extract_locally_relevant_dofs</a> (dof_handler, locally_relevant_dofs);</div><div class="line">      relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u+n_p));</div><div class="line"></div><div class="line">      constraints.clear ();</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#ga3eaa31a679484e80c193e74e8a967dc8">DoFTools::make_hanging_node_constraints</a> (dof_handler,</div><div class="line">                                               constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                0,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                1,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">      rotation_matrix[0][1]=1.;</div><div class="line">      rotation_matrix[1][0]=-1.;</div><div class="line"></div><div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1,dim&gt;</a> offset;</div><div class="line"></div><div class="line">      std::vector&lt;GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator&gt; &gt;</div><div class="line">      periodicity_vector;</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceGridTools.html#aaeadfc0053429f542fbfd48d192b94f0">GridTools::collect_periodic_faces</a>(dof_handler, 2, 3, direction,</div><div class="line">                                        periodicity_vector, offset,</div><div class="line">                                        rotation_matrix);</div><div class="line"></div><div class="line">      std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">      first_vector_components.push_back(0);</div><div class="line"></div><div class="line">      DoFTools::make_periodicity_constraints&lt;DoFHandler&lt;dim&gt; &gt;</div><div class="line">      (periodicity_vector, constraints, fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities),</div><div class="line">       first_vector_components);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                0,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                1,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">    constraints.close ();</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp</div><div class="line">      (owned_partitioning, owned_partitioning,</div><div class="line">       relevant_partitioning, mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#ga38d88a1a559e9fc65d60f3e168921ba5">DoFTools::make_sparsity_pattern</a></div><div class="line">      (dof_handler, bsp, constraints, <span class="keyword">false</span>,</div><div class="line">       <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(mpi_communicator));</div><div class="line"></div><div class="line">      bsp.compress();</div><div class="line"></div><div class="line">      system_matrix.reinit (bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a> (owned_partitioning,</div><div class="line">                       mpi_communicator);</div><div class="line">    solution.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a> (owned_partitioning, relevant_partitioning,</div><div class="line">                     mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system ()</div><div class="line">  {</div><div class="line">    system_matrix=0.;</div><div class="line">    system_rhs=0.;</div><div class="line"></div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>   quadrature_formula(degree+2);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (mapping, fe, quadrature_formula,</div><div class="line">                             <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |</div><div class="line">                             <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>  |</div><div class="line">                             <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div><div class="line">                             <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dofs_per_cell   = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points      = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>   local_matrix (dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       local_rhs (dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices (dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;          right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt; &gt;      rhs_values (n_q_points,</div><div class="line">                                                  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(dim+1));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities (0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure (dim);</div><div class="line"></div><div class="line">    std::vector&lt;SymmetricTensor&lt;2,dim&gt; &gt; symgrad_phi_u (dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  div_phi_u   (dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  phi_p       (dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div><div class="line">    cell = dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(),</div><div class="line">    endc = dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>();</div><div class="line">    <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a> (cell);</div><div class="line">          local_matrix = 0;</div><div class="line">          local_rhs = 0;</div><div class="line"></div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q=0; q&lt;n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  symgrad_phi_u[k] = fe_values[velocities].symmetric_gradient (k, q);</div><div class="line">                  div_phi_u[k]     = fe_values[velocities].divergence (k, q);</div><div class="line">                  phi_p[k]         = fe_values[pressure].value (k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;=i; ++j)</div><div class="line">                    {</div><div class="line">                      local_matrix(i,j) += (symgrad_phi_u[i] * symgrad_phi_u[j]</div><div class="line">                                            - div_phi_u[i] * phi_p[j]</div><div class="line">                                            - phi_p[i] * div_phi_u[j]</div><div class="line">                                            + phi_p[i] * phi_p[j])</div><div class="line">                                           * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  local_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i,q) *</div><div class="line">                                  rhs_values[q](component_i) *</div><div class="line">                                  fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=i+1; j&lt;dofs_per_cell; ++j)</div><div class="line">              local_matrix(i,j) = local_matrix(j,i);</div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices (local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global (local_matrix, local_rhs,</div><div class="line">                                                  local_dof_indices,</div><div class="line">                                                  system_matrix, system_rhs);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress (<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a> (<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve ()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a> A_preconditioner;</div><div class="line">    A_preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html#a89c6576dd9f2b29fc545f25f753d4579">initialize</a>(system_matrix.block(0,0));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div><div class="line">          A_inverse (system_matrix.block(0,0),</div><div class="line">                     A_preconditioner,</div><div class="line">                     owned_partitioning[0],</div><div class="line">                     mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> tmp (owned_partitioning,</div><div class="line">                                            mpi_communicator);</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> schur_rhs (owned_partitioning[1],</div><div class="line">                                               mpi_communicator);</div><div class="line">      A_inverse.vmult (tmp.block(0), system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div><div class="line">      system_matrix.block(1,0).vmult (schur_rhs, tmp.block(0));</div><div class="line">      schur_rhs -= system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1);</div><div class="line"></div><div class="line">      SchurComplement&lt;TrilinosWrappers::PreconditionJacobi&gt;</div><div class="line">      schur_complement (system_matrix, A_inverse,</div><div class="line">                        owned_partitioning[0],</div><div class="line">                        mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control (solution.block(1).<a class="code" href="classVector.html#a8005bf1ec399c608c3755c1d22960add">size</a>(),</div><div class="line">                                    1e-6*schur_rhs.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line"></div><div class="line">      TrilinosWrappers::PreconditionAMG preconditioner;</div><div class="line">      preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a> (system_matrix.block(1,1));</div><div class="line"></div><div class="line">      InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                    TrilinosWrappers::PreconditionAMG&gt;</div><div class="line">                    m_inverse (system_matrix.block(1,1), preconditioner,</div><div class="line">                               owned_partitioning[1], mpi_communicator);</div><div class="line"></div><div class="line">      cg.solve (schur_complement,</div><div class="line">                tmp.block(1),</div><div class="line">                schur_rhs,</div><div class="line">                preconditioner);</div><div class="line"></div><div class="line">      constraints.distribute (tmp);</div><div class="line">      solution.block(1)=tmp.block(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.block(0,1).vmult (tmp.block(0), tmp.block(1));</div><div class="line">      tmp.block(0) *= -1;</div><div class="line">      tmp.block(0) += system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0);</div><div class="line"></div><div class="line">      A_inverse.vmult (tmp.block(0), tmp.block(0));</div><div class="line"></div><div class="line">      constraints.distribute (tmp);</div><div class="line">      solution.block(0)=tmp.block(0);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  StokesProblem&lt;dim&gt;::output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword">  const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    std::vector&lt;std::string&gt; solution_names (dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.push_back (<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line"></div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">    data_component_interpretation</div><div class="line">    (dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation</div><div class="line">    .push_back (<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a> (dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a> (solution, solution_names,</div><div class="line">                              <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                              data_component_interpretation);</div><div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain (triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a> (subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a> (mapping, degree+1);</div><div class="line"></div><div class="line">    std::ostringstream filename;</div><div class="line">    filename &lt;&lt; <span class="stringliteral">&quot;solution-&quot;</span></div><div class="line">             &lt;&lt; <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (refinement_cycle, 2)</div><div class="line">             &lt;&lt; <span class="stringliteral">&quot;.&quot;</span></div><div class="line">             &lt;&lt; <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>(),2)</div><div class="line">             &lt;&lt; <span class="stringliteral">&quot;.vtu&quot;</span>;</div><div class="line"></div><div class="line">    std::ofstream output (filename.str().c_str());</div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a> (output);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0)</div><div class="line">      {</div><div class="line">        std::vector&lt;std::string&gt; filenames;</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD); ++i)</div><div class="line">          filenames.push_back (std::string(<span class="stringliteral">&quot;solution-&quot;</span>) +</div><div class="line">                               <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (refinement_cycle, 2) +</div><div class="line">                               <span class="stringliteral">&quot;.&quot;</span> +</div><div class="line">                               <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(i, 2) +</div><div class="line">                               <span class="stringliteral">&quot;.vtu&quot;</span>);</div><div class="line">        <span class="keyword">const</span> std::string</div><div class="line">        pvtu_master_filename = (<span class="stringliteral">&quot;solution-&quot;</span> +</div><div class="line">                                <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (refinement_cycle, 2) +</div><div class="line">                                <span class="stringliteral">&quot;.pvtu&quot;</span>);</div><div class="line">        std::ofstream pvtu_master (pvtu_master_filename.c_str());</div><div class="line">        data_out.<a class="code" href="classDataOutInterface.html#a1eff778443cd0431cd807c45b6ae16d9">write_pvtu_record</a> (pvtu_master, filenames);</div><div class="line">      }</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  StokesProblem&lt;dim&gt;::refine_mesh ()</div><div class="line">  {</div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell (triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line">    <a class="code" href="classKellyErrorEstimator.html#a971b0bfe57fa21867ed3c06794487e4b">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div><div class="line">                                        <a class="code" href="classQGauss.html">QGauss&lt;dim-1&gt;</a>(degree+1),</div><div class="line">                                        <span class="keyword">typename</span> <a class="code" href="structFunctionMap.html#a6bb95bc991dd3337330f1c725f59b008">FunctionMap&lt;dim&gt;::type</a>(),</div><div class="line">                                        solution,</div><div class="line">                                        estimated_error_per_cell,</div><div class="line">                                        fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(pressure));</div><div class="line"></div><div class="line">    <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#a7f0ebf71078b6da3e0cbb895fcf15b12">parallel::distributed::GridRefinement::</a></div><div class="line"><a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#a7f0ebf71078b6da3e0cbb895fcf15b12">    refine_and_coarsen_fixed_number</a> (triangulation,</div><div class="line">                                     estimated_error_per_cell,</div><div class="line">                                     0.3, 0.0);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a> ();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::run ()</div><div class="line">  {</div><div class="line">    create_mesh();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle&lt;9;</div><div class="line">         ++refinement_cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div><div class="line">          refine_mesh ();</div><div class="line"></div><div class="line">        setup_dofs ();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">        assemble_system ();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div><div class="line">        solve ();</div><div class="line"></div><div class="line">        output_results (refinement_cycle);</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step45;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization (argc, argv, 1);</div><div class="line">      StokesProblem&lt;2&gt; flow_problem(1);</div><div class="line">      flow_problem.run ();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
