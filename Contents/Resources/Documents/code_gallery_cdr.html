<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The &#39;Convection Diffusion Reaction&#39; code gallery program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2017 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The 'Convection Diffusion Reaction' code gallery program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p> 
<p align="center"> 
  This program was contributed by David R. Wells wellsd2@rpi.edu.
  <br>
  It comes without any warranty or support by its authors or the authors of deal.II.
</p>

</p>
<p>This program is part of the <a class="el" href="CodeGallery.html">deal.II code gallery</a> and consists of the following files (click to inspect):</p><ul>
<li><a href="../code-gallery/cdr/readme.md">readme.md</a> (<a href="#ann-readme.md">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/CMakeLists.txt">CMakeLists.txt</a></li>
<li><a href="../code-gallery/cdr/common/CMakeLists.txt">common/CMakeLists.txt</a></li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/parameters.h">common/include/deal.II-cdr/parameters.h</a> (<a href="#ann-common/include/deal.II-cdr/parameters.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/system_matrix.h">common/include/deal.II-cdr/system_matrix.h</a> (<a href="#ann-common/include/deal.II-cdr/system_matrix.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/system_matrix.templates.h">common/include/deal.II-cdr/system_matrix.templates.h</a> (<a href="#ann-common/include/deal.II-cdr/system_matrix.templates.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/system_rhs.h">common/include/deal.II-cdr/system_rhs.h</a> (<a href="#ann-common/include/deal.II-cdr/system_rhs.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/system_rhs.templates.h">common/include/deal.II-cdr/system_rhs.templates.h</a> (<a href="#ann-common/include/deal.II-cdr/system_rhs.templates.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/write_pvtu_output.h">common/include/deal.II-cdr/write_pvtu_output.h</a> (<a href="#ann-common/include/deal.II-cdr/write_pvtu_output.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/include/deal.II-cdr/write_pvtu_output.templates.h">common/include/deal.II-cdr/write_pvtu_output.templates.h</a> (<a href="#ann-common/include/deal.II-cdr/write_pvtu_output.templates.h">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/source/parameters.cc">common/source/parameters.cc</a> (<a href="#ann-common/source/parameters.cc">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/source/system_matrix.cc">common/source/system_matrix.cc</a> (<a href="#ann-common/source/system_matrix.cc">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/source/system_rhs.cc">common/source/system_rhs.cc</a> (<a href="#ann-common/source/system_rhs.cc">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/common/source/write_pvtu_output.cc">common/source/write_pvtu_output.cc</a> (<a href="#ann-common/source/write_pvtu_output.cc">annotated version</a>)</li>
<li><a href="../code-gallery/cdr/doc/entry-name">doc/entry-name</a></li>
<li><a href="../code-gallery/cdr/parameters.prm">parameters.prm</a></li>
<li><a href="../code-gallery/cdr/solver/CMakeLists.txt">solver/CMakeLists.txt</a></li>
<li><a href="../code-gallery/cdr/solver/cdr.cc">solver/cdr.cc</a> (<a href="#ann-solver/cdr.cc">annotated version</a>)</li>
</ul>
<p><a class="anchor" id="ann-readme.md"></a> </p><h1>Annotated version of readme.md</h1>
<h2>Overview</h2>
<p>I started this project with the intent of better understanding adaptive mesh refinement, parallel computing, and <code>CMake</code>. In particular, I started by writing a uniform mesh, single process solver and then ultimately expanded it into <code>solver/cdr.cc</code>. This example program might be useful to look at if you want to see: </p><ul>
<li>
A more complex <code>CMake</code> setup, which builds a shared object library and an executable </li>
<li>
A simple parallel time stepping problem </li>
<li>
Use of <code>C++11</code> lambda functions </li>
</ul>
<p>The other solvers are available <a href="http://www.github.com/drwells/dealii-cdr">here</a>.</p>
<p>Unlike the other tutorial programs, I have split this solver into a number of files in nested directories. In particular, I used the following strategy (more-or-less copied <a href="http://aspect.dealii.org">ASPECT</a>): </p><ul>
<li>
The <code>common</code> directory, which hosts files common to the four solvers I wrote along the way. Most of the source files in <code>common/source/</code> are just <em>template specializations</em>; they compile the template code for specific dimensions and linear algebra (matrix or vector) types. The <code>common/include/deal.II-cdr/</code> directory contains both templates and plain header files. </li>
<li>
The <code>solver/</code> directory contains the actual solver class and strongly resembles a tutorial program. The file <code>solver/cdr.cc</code> just sets up data structures and then calls routines in <code>libdeal.II-cdr-common</code> to populate them and produce output. </li>
</ul>
<h2>Requirements</h2>
<ul>
<li>
A <code>C++-11</code> compliant compiler </li>
<li>
Version 8.4 of <code>deal.II</code> </li>
</ul>
<h2>Compiling and running</h2>
<p>Like the example programs, run </p><div class="fragment"><div class="line">cmake -DDEAL_II_DIR=/path/to/deal.II .</div><div class="line">make</div></div><!-- fragment --><p> in this directory. The solver may be run as </p><div class="fragment"><div class="line">make run</div></div><!-- fragment --><p> or, for parallelism across <code>16</code> processes, </p><div class="fragment"><div class="line">mpirun -np 16 ./cdr</div></div><!-- fragment --><h2>Why use convection-diffusion-reaction?</h2>
<p>This equation exhibits very fine boundary layers (usually, from the literature, these layers have width equal to the square root of the diffusion coefficient on internal layers and the diffusion coefficient on boundary layers). A good way to solve it is to use adaptive mesh refinement to refine the mesh only at interior boundary layers. At the same time, this problem is linear (and does not have a pressure term) so it is much simpler to solve than the Navier-Stokes equations with comparable diffusion (Reynolds number).</p>
<p>I use relatively large diffusion values so I can get away without any additional scheme like SUPG.</p>
<h2>Recommended Literature</h2>
<p>There are many good books and papers on numerical methods for this equation. A good starting point is "Robust Numerical Methods for Singularly Perturbed
Problems" by Roos, Stynes, and Tobiska.</p>
<p><a class="anchor" id="ann-common/include/deal.II-cdr/parameters.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/parameters.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_parameters_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_parameters_h</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/parameter_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div></div><!-- fragment --><p>I prefer to use the <a class="el" href="classParameterHandler.html">ParameterHandler</a> class in a slightly different way than usual: The class Parameters creates, uses, and then destroys a <a class="el" href="classParameterHandler.html">ParameterHandler</a> inside the <code>read_parameter_file</code> method instead of keeping it around. This is nice because now all of the run time parameters are contained in a simple class and it can be copied or passed around very easily.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">class </span>Parameters</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">double</span> inner_radius;</div><div class="line">    <span class="keywordtype">double</span> outer_radius;</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> diffusion_coefficient;</div><div class="line">    <span class="keywordtype">double</span> reaction_coefficient;</div><div class="line">    <span class="keywordtype">bool</span> time_dependent_forcing;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement_level;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_refinement_level;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_order;</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> start_time;</div><div class="line">    <span class="keywordtype">double</span> stop_time;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> save_interval;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> patch_level;</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> read_parameter_file(<span class="keyword">const</span> std::string &amp;file_name);</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> configure_parameter_handler(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;parameter_handler);</div><div class="line">  };</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/system_matrix.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/system_matrix.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_system_matrix_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_system_matrix_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div></div><!-- fragment --><p>One of the goals I had in writing this entry was to split up functions into different compilation units instead of using one large file. This is the header file for a pair of functions (only one of which I ultimately use) which build the system matrix.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> MatrixType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_matrix</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           time_step,</div><div class="line">   MatrixType                                            &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> MatrixType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_matrix</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                                &amp;constraints,</div><div class="line">   MatrixType                                            &amp;system_matrix);</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/system_matrix.templates.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/system_matrix.templates.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_system_matrix_templates_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_system_matrix_templates_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div></div><!-- fragment --><p>This is the actual implementation of the <code>create_system_matrix</code> function described in the header file. It is similar to the system matrix assembly routine in <a class="el" href="step_40.html">step-40</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> UpdateFunction&gt;</div><div class="line"><span class="keywordtype">void</span> internal_create_system_matrix</div><div class="line">(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line"> <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line"> <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line"> <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line"> <span class="keyword">const</span> <span class="keywordtype">double</span>                                           time_step,</div><div class="line"> UpdateFunction                                         update_system_matrix)</div><div class="line">{</div><div class="line">  <span class="keyword">auto</span> &amp;fe = dof_handler.<a class="code" href="classDoFHandler.html#ababc43bc9d09faea98dca14a2b6352a1">get_fe</a>();</div><div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, quad, <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_indices(dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    {</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a>(cell);</div><div class="line">          cell_matrix = 0.0;</div><div class="line">          cell-&gt;get_dof_indices(local_indices);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; quad.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); ++q)</div><div class="line">            {</div><div class="line">              <span class="keyword">const</span> <span class="keyword">auto</span> current_convection =</div><div class="line">                convection_function(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q));</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                    {</div><div class="line">                      <span class="keyword">const</span> <span class="keyword">auto</span> convection_contribution = current_convection</div><div class="line">                        *fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q);</div><div class="line">                      cell_matrix(i, j) += fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q)*</div></div><!-- fragment --><p>Here are the time step, mass, and reaction parts:</p>
<div class="fragment"><div class="line">((1.0 + time_step/2.0*parameters.reaction_coefficient)</div><div class="line"> *fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)*fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q)</div><div class="line"> + time_step/2.0*</div></div><!-- fragment --><p>and the convection part:</p>
<div class="fragment"><div class="line">(fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)*convection_contribution</div></div><!-- fragment --><p>and, finally, the diffusion part:</p>
<div class="fragment"><div class="line">                            + parameters.diffusion_coefficient</div><div class="line">                            *(fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(i, q)*fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q)))</div><div class="line">                           );</div><div class="line">                      }</div><div class="line">                  }</div><div class="line">              }</div><div class="line">            update_system_matrix(local_indices, cell_matrix);</div><div class="line">          }</div><div class="line">      }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> MatrixType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_matrix</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                                &amp;constraints,</div><div class="line">   MatrixType                                            &amp;system_matrix)</div><div class="line">  {</div><div class="line">    internal_create_system_matrix&lt;dim&gt;</div><div class="line">      (dof_handler, quad, convection_function, parameters, time_step,</div><div class="line">       [&amp;constraints, &amp;system_matrix](<span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;local_indices,</div><div class="line">                                      <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;cell_matrix)</div><div class="line">       {</div><div class="line">         constraints.distribute_local_to_global</div><div class="line">           (cell_matrix, local_indices, system_matrix);</div><div class="line">       });</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> MatrixType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_matrix</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           time_step,</div><div class="line">   MatrixType                                            &amp;system_matrix)</div><div class="line">  {</div><div class="line">    internal_create_system_matrix&lt;dim&gt;</div><div class="line">      (dof_handler, quad, convection_function, parameters, time_step,</div><div class="line">       [&amp;system_matrix](<span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;local_indices,</div><div class="line">                        <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;cell_matrix)</div><div class="line">       {</div><div class="line">         system_matrix.add(local_indices, cell_matrix);</div><div class="line">       });</div><div class="line">  }</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/system_rhs.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/system_rhs.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_system_rhs_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_system_rhs_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/point.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/tensor.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div></div><!-- fragment --><p>Similarly to <code>create_system_matrix</code>, I wrote a separate function to compute the right hand side.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_rhs</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> VectorType                                      &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                                &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           current_time,</div><div class="line">   VectorType                                            &amp;system_rhs);</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/system_rhs.templates.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/system_rhs.templates.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_system_rhs_templates_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_system_rhs_templates_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/point.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/tensor.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_rhs.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> create_system_rhs</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                                 &amp;parameters,</div><div class="line">   <span class="keyword">const</span> VectorType                                      &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                                &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                           current_time,</div><div class="line">   VectorType                                            &amp;system_rhs)</div><div class="line">  {</div><div class="line">    <span class="keyword">auto</span> &amp;fe = dof_handler.<a class="code" href="classDoFHandler.html#ababc43bc9d09faea98dca14a2b6352a1">get_fe</a>();</div><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> time_step = (parameters.stop_time - parameters.start_time)</div><div class="line">      /parameters.n_time_steps;</div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, quad, <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cell_rhs(dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix(dofs_per_cell, dofs_per_cell);</div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> current_fe_coefficients(dofs_per_cell);</div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_indices(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> previous_time {current_time - time_step};</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">          {</div><div class="line">            fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a>(cell);</div><div class="line">            cell_rhs = 0.0;</div><div class="line">            cell-&gt;get_dof_indices(local_indices);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">              {</div><div class="line">                current_fe_coefficients[i] = previous_solution[local_indices[i]];</div><div class="line">              }</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; quad.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); ++q)</div><div class="line">              {</div><div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> current_convection =</div><div class="line">                  convection_function(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q));</div><div class="line"></div><div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> current_forcing = forcing_function</div><div class="line">                  (current_time, fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q));</div><div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> previous_forcing = forcing_function</div><div class="line">                  (previous_time, fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q));</div><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                  {</div><div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                      {</div><div class="line">                        <span class="keyword">const</span> <span class="keyword">auto</span> convection_contribution = current_convection</div><div class="line">                          *fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q);</div><div class="line"></div><div class="line">                        cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q)*</div></div><!-- fragment --><p>Here are the mass and reaction part:</p>
<div class="fragment"><div class="line">(((1.0 - time_step/2.0*parameters.reaction_coefficient)</div><div class="line">  *fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)*fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q)</div><div class="line">  - time_step/2.0*</div></div><!-- fragment --><p>the convection part:</p>
<div class="fragment"><div class="line">(fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)*convection_contribution</div></div><!-- fragment --><p>the diffusion part:</p>
<div class="fragment"><div class="line">  + parameters.diffusion_coefficient</div><div class="line">  *(fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(i, q)*fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q))))</div><div class="line">*current_fe_coefficients[j]</div></div><!-- fragment --><p>and, finally, the forcing function part:</p>
<div class="fragment"><div class="line">                           + time_step/2.0*</div><div class="line">                           (current_forcing + previous_forcing)</div><div class="line">                           *fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q));</div><div class="line">                      }</div><div class="line">                  }</div><div class="line">              }</div><div class="line">            constraints.<a class="code" href="classConstraintMatrix.html#a1c61203741d499990c6288c3fcf3d48c">distribute_local_to_global</a>(cell_rhs, local_indices, system_rhs);</div><div class="line">          }</div><div class="line">      }</div><div class="line">  }</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/write_pvtu_output.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/write_pvtu_output.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_write_pvtu_output_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_write_pvtu_output_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div></div><!-- fragment --><p>This is a small class which handles PVTU output.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">class </span>WritePVTUOutput</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    WritePVTUOutput(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> patch_level);</div><div class="line"></div><div class="line">    <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> VectorType&gt;</div><div class="line">    <span class="keywordtype">void</span> write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> &amp;dof_handler,</div><div class="line">                      <span class="keyword">const</span> VectorType      &amp;solution,</div><div class="line">                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     time_step_n,</div><div class="line">                      <span class="keyword">const</span> <span class="keywordtype">double</span>           current_time);</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> patch_level;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> this_mpi_process;</div><div class="line">  };</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/include/deal.II-cdr/write_pvtu_output.templates.h"></a> </p><h1>Annotated version of common/include/deal.II-cdr/write_pvtu_output.templates.h</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef dealii__cdr_write_pvtu_output_templates_h</span></div><div class="line"><span class="preprocessor">#define dealii__cdr_write_pvtu_output_templates_h</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/data_out_base.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/utilities.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/write_pvtu_output.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div></div><!-- fragment --><p>Here is the implementation of the important function. This is similar to what is presented in <a class="el" href="step_40.html">step-40</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim, <span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> WritePVTUOutput::write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> &amp;dof_handler,</div><div class="line">                                     <span class="keyword">const</span> VectorType      &amp;solution,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     time_step_n,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>           current_time)</div><div class="line">  {</div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;u&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;triangulation = dof_handler.<a class="code" href="classDoFHandler.html#a908b67a133cc235ae35c8ba5fa38fd02">get_triangulation</a>();</div><div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain (triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;domain : subdomain)</div><div class="line">      {</div><div class="line">        domain = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">      }</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>(patch_level);</div><div class="line"></div><div class="line">    <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a> flags;</div><div class="line">    flags.<a class="code" href="structDataOutBase_1_1VtkFlags.html#a8944cf4f29e449a73c11c6f348b86c20">time</a> = current_time;</div></div><!-- fragment --><p>While the default flag is for the best compression level, using <code>best_speed</code> makes this function much faster.</p>
<div class="fragment"><div class="line">    flags.<a class="code" href="structDataOutBase_1_1VtkFlags.html#a3be0d6de1c92b770e8664bce2fc7c107">compression_level</a> = DataOutBase::VtkFlags::ZlibCompressionLevel::best_speed;</div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(flags);</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subdomain_n;</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1)</div><div class="line">      {</div><div class="line">        subdomain_n = 0;</div><div class="line">      }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">      {</div><div class="line">        subdomain_n = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">      }</div><div class="line"></div><div class="line">    std::ofstream output</div><div class="line">      (<span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(time_step_n) + <span class="stringliteral">&quot;.&quot;</span></div><div class="line">       + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(subdomain_n, 4)</div><div class="line">       + <span class="stringliteral">&quot;.vtu&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(output);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (this_mpi_process == 0)</div><div class="line">      {</div><div class="line">        std::vector&lt;std::string&gt; filenames;</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD);</div><div class="line">             ++i)</div><div class="line">          filenames.push_back</div><div class="line">            (<span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (time_step_n) + <span class="stringliteral">&quot;.&quot;</span></div><div class="line">             + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a> (i, 4) + <span class="stringliteral">&quot;.vtu&quot;</span>);</div><div class="line">        std::ofstream master_output</div><div class="line">          (<span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(time_step_n) + <span class="stringliteral">&quot;.pvtu&quot;</span>);</div><div class="line">        data_out.<a class="code" href="classDataOutInterface.html#a1eff778443cd0431cd807c45b6ae16d9">write_pvtu_record</a>(master_output, filenames);</div><div class="line">      }</div><div class="line">  }</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p><a class="anchor" id="ann-common/source/parameters.cc"></a> </p><h1>Annotated version of common/source/parameters.cc</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keywordtype">void</span> Parameters::configure_parameter_handler(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;parameter_handler)</div><div class="line">  {</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Geometry&quot;</span>);</div><div class="line">    {</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;inner_radius&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), <span class="stringliteral">&quot;Inner radius.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;outer_radius&quot;</span>, <span class="stringliteral">&quot;2.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), <span class="stringliteral">&quot;Outer radius.&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Physical Parameters&quot;</span>);</div><div class="line">    {</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;diffusion_coefficient&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), <span class="stringliteral">&quot;Diffusion coefficient.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;reaction_coefficient&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), <span class="stringliteral">&quot;Reaction coefficient.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;time_dependent_forcing&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>, <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(), <span class="stringliteral">&quot;Whether or not &quot;</span></div><div class="line">       <span class="stringliteral">&quot;the forcing function depends on time.&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Finite Element&quot;</span>);</div><div class="line">    {</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;initial_refinement_level&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div><div class="line">       <span class="stringliteral">&quot;Initial number of levels in the mesh.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;max_refinement_level&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div><div class="line">       <span class="stringliteral">&quot;Maximum number of levels in the mesh.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;fe_order&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1), <span class="stringliteral">&quot;Finite element order.&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Time Step&quot;</span>);</div><div class="line">    {</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;start_time&quot;</span>, <span class="stringliteral">&quot;0.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), <span class="stringliteral">&quot;Start time.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;stop_time&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>, <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(1.0), <span class="stringliteral">&quot;Stop time.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;n_time_steps&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1), <span class="stringliteral">&quot;Number of time steps.&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Output&quot;</span>);</div><div class="line">    {</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;save_interval&quot;</span>, <span class="stringliteral">&quot;10&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1), <span class="stringliteral">&quot;Save interval.&quot;</span>);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a></div><div class="line">      (<span class="stringliteral">&quot;patch_level&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0), <span class="stringliteral">&quot;Patch level.&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> Parameters::read_parameter_file(<span class="keyword">const</span> std::string &amp;file_name)</div><div class="line">  {</div><div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> parameter_handler;</div><div class="line">    {</div><div class="line">      std::ifstream file(file_name);</div><div class="line">      configure_parameter_handler(parameter_handler);</div><div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#abc4fe419ccc4b128ec2bad5e0dec62ac">read_input</a>(file);</div><div class="line">    }</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Geometry&quot;</span>);</div><div class="line">    {</div><div class="line">      inner_radius = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;inner_radius&quot;</span>);</div><div class="line">      outer_radius = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;outer_radius&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Physical Parameters&quot;</span>);</div><div class="line">    {</div><div class="line">      diffusion_coefficient = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;diffusion_coefficient&quot;</span>);</div><div class="line">      reaction_coefficient = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;reaction_coefficient&quot;</span>);</div><div class="line">      time_dependent_forcing = parameter_handler.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;time_dependent_forcing&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Finite Element&quot;</span>);</div><div class="line">    {</div><div class="line">      initial_refinement_level = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;initial_refinement_level&quot;</span>);</div><div class="line">      max_refinement_level = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;max_refinement_level&quot;</span>);</div><div class="line">      fe_order = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;fe_order&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Time Step&quot;</span>);</div><div class="line">    {</div><div class="line">      start_time = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;start_time&quot;</span>);</div><div class="line">      stop_time = parameter_handler.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;stop_time&quot;</span>);</div><div class="line">      n_time_steps = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;n_time_steps&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line"></div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Output&quot;</span>);</div><div class="line">    {</div><div class="line">      save_interval = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;save_interval&quot;</span>);</div><div class="line">      patch_level = parameter_handler.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;patch_level&quot;</span>);</div><div class="line">    }</div><div class="line">    parameter_handler.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="ann-common/source/system_matrix.cc"></a> </p><h1>Annotated version of common/source/system_matrix.cc</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_sparse_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_matrix.templates.h&gt;</span></div></div><!-- fragment --><p>This file exists just to build template specializations of <code>create_system_matrix</code>. Even though the solver is run in parallel with Trilinos objects, other serial solvers can use the same function without recompilation by compiling everything here just one time.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;2, SparseMatrix&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>                              &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;3, SparseMatrix&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>                              &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;2, SparseMatrix&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                            &amp;constraints,</div><div class="line">   <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>                              &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;3, SparseMatrix&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                            &amp;constraints,</div><div class="line">   <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>                              &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;2, TrilinosWrappers::SparseMatrix&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   TrilinosWrappers::SparseMatrix                    &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;3, TrilinosWrappers::SparseMatrix&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   TrilinosWrappers::SparseMatrix                    &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;2, TrilinosWrappers::SparseMatrix&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                            &amp;constraints,</div><div class="line">   TrilinosWrappers::SparseMatrix                    &amp;system_matrix);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_matrix&lt;3, TrilinosWrappers::SparseMatrix&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                               &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                   &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                             &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                       time_step,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                            &amp;constraints,</div><div class="line">   TrilinosWrappers::SparseMatrix                    &amp;system_matrix);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="ann-common/source/system_rhs.cc"></a> </p><h1>Annotated version of common/source/system_rhs.cc</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_vector.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_rhs.templates.h&gt;</span></div></div><!-- fragment --><p>Like <code>system_matrix.cc</code>, this file just compiles template specializations.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_rhs&lt;2, Vector&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt;   &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                               &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                                &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                              &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                         current_time,</div><div class="line">   <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                                      &amp;system_rhs);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_rhs&lt;3, Vector&lt;double&gt;&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt;   &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                               &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                                &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                              &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                         current_time,</div><div class="line">   <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                                      &amp;system_rhs);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_rhs&lt;2, TrilinosWrappers::MPI::Vector&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;2&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 2&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt;   &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;2&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                               &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>                 &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                              &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                         current_time,</div><div class="line">   <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>                       &amp;system_rhs);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> create_system_rhs&lt;3, TrilinosWrappers::MPI::Vector&gt;</div><div class="line">  (<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                                 &amp;dof_handler,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;3&gt;</a>                                     &amp;quad,</div><div class="line">   <span class="keyword">const</span> std::function&lt;Tensor&lt;1, 3&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt;   &amp;convection_function,</div><div class="line">   <span class="keyword">const</span> std::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;3&gt;</a>)&gt; &amp;forcing_function,</div><div class="line">   <span class="keyword">const</span> CDR::Parameters                               &amp;parameters,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>                 &amp;previous_solution,</div><div class="line">   <span class="keyword">const</span> <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>                              &amp;constraints,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span>                                         current_time,</div><div class="line">   <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>                       &amp;system_rhs);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="ann-common/source/write_pvtu_output.cc"></a> </p><h1>Annotated version of common/source/write_pvtu_output.cc</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_vector.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/write_pvtu_output.templates.h&gt;</span></div></div><!-- fragment --><p>Again, this file just compiles the constructor and also the templated functions.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>CDR</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  WritePVTUOutput::WritePVTUOutput(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> patch_level)</div><div class="line">    : patch_level {patch_level},</div><div class="line">      this_mpi_process {<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD)}</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> WritePVTUOutput::write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>  &amp;dof_handler,</div><div class="line">                                     <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;solution,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    time_step_n,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>          current_time);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> WritePVTUOutput::write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>  &amp;dof_handler,</div><div class="line">                                     <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;solution,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    time_step_n,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>          current_time);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> WritePVTUOutput::write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;2&gt;</a>                 &amp;dof_handler,</div><div class="line">                                     <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;solution,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                   time_step_n,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>                         current_time);</div><div class="line"></div><div class="line">  <span class="keyword">template</span></div><div class="line">  <span class="keywordtype">void</span> WritePVTUOutput::write_output(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;3&gt;</a>                 &amp;dof_handler,</div><div class="line">                                     <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;solution,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                   time_step_n,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>                         current_time);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="ann-solver/cdr.cc"></a> </p><h1>Annotated version of solver/cdr.cc</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/conditional_ostream.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_generator.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/manifold_lib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/dynamic_sparsity_pattern.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/error_estimator.h&gt;</span></div></div><!-- fragment --><p>These headers are for distributed computations:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/utilities.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/index_set.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/distributed/tria.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/distributed/grid_refinement.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/distributed/solution_transfer.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparsity_tools.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_solver.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_precondition.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/trilinos_vector.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/system_rhs.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/parameters.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II-cdr/write_pvtu_output.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">constexpr <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#a9f062a82e4dab1dd631a2c4fa8162bea">manifold_id</a> {0};</div></div><!-- fragment --><p>This is the actual solver class which performs time iteration and calls the appropriate library functions to do it.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>CDRProblem</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  CDRProblem(<span class="keyword">const</span> CDR::Parameters &amp;parameters);</div><div class="line">  <span class="keywordtype">void</span> run();</div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> CDR::Parameters parameters;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> time_step;</div><div class="line">  <span class="keywordtype">double</span> current_time;</div><div class="line"></div><div class="line">  MPI_Comm mpi_communicator;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_mpi_processes;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> this_mpi_process;</div><div class="line"></div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a> fe;</div><div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quad;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classSphericalManifold.html">SphericalManifold&lt;dim&gt;</a> boundary_description;</div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> triangulation;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::function&lt;Tensor&lt;1, dim&gt;(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>)&gt; convection_function;</div><div class="line">  <span class="keyword">const</span> std::function&lt;double(double, const Point&lt;dim&gt;)&gt; forcing_function;</div><div class="line"></div><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs;</div><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line"></div><div class="line">  <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a> constraints;</div><div class="line">  <span class="keywordtype">bool</span> first_run;</div></div><!-- fragment --><p>As is usual in parallel programs, I keep two copies of parts of the complete solution: <code>locally_relevant_solution</code> contains both the locally calculated solution as well as the layer of cells at its boundary (the ghost cells) while <code>completely_distributed_solution</code> only contains the parts of the solution computed on the current <a class="el" href="DEALGlossary.html#GlossMPIProcess">MPI process</a>.</p>
<div class="fragment"><div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> locally_relevant_solution;</div><div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> completely_distributed_solution;</div><div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> system_rhs;</div><div class="line">  TrilinosWrappers::SparseMatrix system_matrix;</div><div class="line">  TrilinosWrappers::PreconditionAMG preconditioner;</div><div class="line"></div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> setup_geometry();</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> setup_dofs();</div><div class="line">  <span class="keywordtype">void</span> refine_mesh();</div><div class="line">  <span class="keywordtype">void</span> time_iterate();</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">CDRProblem&lt;dim&gt;::CDRProblem(<span class="keyword">const</span> CDR::Parameters &amp;parameters) :</div><div class="line">  parameters(parameters),</div><div class="line">  time_step {(parameters.stop_time - parameters.start_time)</div><div class="line">             /parameters.n_time_steps},</div><div class="line">  current_time {parameters.start_time},</div><div class="line">  mpi_communicator (MPI_COMM_WORLD),</div><div class="line">  n_mpi_processes {<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator)},</div><div class="line">  this_mpi_process {<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(mpi_communicator)},</div><div class="line">  fe(parameters.fe_order),</div><div class="line">  quad(parameters.fe_order + 2),</div><div class="line">  boundary_description(<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>()),</div><div class="line">  triangulation(mpi_communicator, <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::MeshSmoothing</a></div><div class="line">                (<a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::smoothing_on_refinement</a> |</div><div class="line">                 <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::smoothing_on_coarsening</a>)),</div><div class="line">  dof_handler(triangulation),</div><div class="line">  convection_function</div><div class="line">  {</div><div class="line">    [](<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> p) -&gt; <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">      {<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> v; v[0] = -p[1]; v[1] = p[0]; <span class="keywordflow">return</span> v;}</div><div class="line">  },</div><div class="line">  forcing_function</div><div class="line">  {</div><div class="line">    [](<span class="keywordtype">double</span> t, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> p) -&gt; <span class="keywordtype">double</span></div><div class="line">      {</div><div class="line">        <span class="keywordflow">return</span> std::exp(-8*t)*std::exp(-40*Utilities::fixed_power&lt;6&gt;(p[0] - 1.5))</div><div class="line">          *std::exp(-40*Utilities::fixed_power&lt;6&gt;(p[1]));</div><div class="line">      }</div><div class="line">  },</div><div class="line">  first_run {<span class="keyword">true</span>},</div><div class="line">  pcout (std::cout, this_mpi_process == 0)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::setup_geometry()</div><div class="line">{</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> center;</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a>(triangulation, center, parameters.inner_radius,</div><div class="line">                             parameters.outer_radius);</div><div class="line">  triangulation.<a class="code" href="group__manifold.html#ga9f9d720f5fbdcdf3dcbb445feefbdb9f">set_manifold</a>(manifold_id, boundary_description);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : triangulation.<a class="code" href="group__CPP11.html#ga4288670ae5bd80367e24918d542cb2d8">active_cell_iterators</a>())</div><div class="line">    {</div><div class="line">      cell-&gt;set_all_manifold_ids(manifold_id);</div><div class="line">    }</div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(parameters.initial_refinement_level);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::setup_dofs()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span></div><div class="line">        &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">        &lt;&lt; std::endl;</div><div class="line">  locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">  <a class="code" href="namespaceDoFTools.html#af0eef74bf66f0bfa8847f66fe6c8908d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line"></div><div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a24120d0331183f9a63cbe41493a19f6b">clear</a>();</div><div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#ac2726821354883ac97fe7e6181de9792">reinit</a>(locally_relevant_dofs);</div><div class="line">  <a class="code" href="group__constraints.html#ga3eaa31a679484e80c193e74e8a967dc8">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  <a class="code" href="group__constraints.html#gaa2268fcc4cc5295e084a87f423989273">DoFTools::make_zero_boundary_constraints</a>(dof_handler, manifold_id, constraints);</div><div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a8056d07faa2a7ed3f158c1b42d56abc8">close</a>();</div><div class="line"></div><div class="line">  completely_distributed_solution.reinit</div><div class="line">  (locally_owned_dofs, mpi_communicator);</div><div class="line"></div><div class="line">  locally_relevant_solution.reinit(locally_owned_dofs, locally_relevant_dofs,</div><div class="line">                                   mpi_communicator);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dynamic_sparsity_pattern(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  <a class="code" href="group__constraints.html#ga38d88a1a559e9fc65d60f3e168921ba5">DoFTools::make_sparsity_pattern</a>(dof_handler, dynamic_sparsity_pattern,</div><div class="line">                                  constraints, / *keep_constrained_dofs* /<span class="keyword">true</span>);</div><div class="line">  <a class="code" href="namespaceSparsityTools.html#ae2c7bdbdb62642f60d60087e4cb6195f">SparsityTools::distribute_sparsity_pattern</a></div><div class="line">  (dynamic_sparsity_pattern, dof_handler.<a class="code" href="classDoFHandler.html#aff791a67d5a9383fb2ef05ea540b71e8">n_locally_owned_dofs_per_processor</a>(),</div><div class="line">   mpi_communicator, locally_relevant_dofs);</div><div class="line"></div><div class="line">  system_rhs.reinit(locally_owned_dofs, mpi_communicator);</div><div class="line">  system_matrix.reinit(locally_owned_dofs, dynamic_sparsity_pattern,</div><div class="line">                       mpi_communicator);</div><div class="line"></div><div class="line">  CDR::create_system_matrix&lt;dim&gt;</div><div class="line">  (dof_handler, quad, convection_function, parameters, time_step, constraints,</div><div class="line">   system_matrix);</div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::time_iterate()</div><div class="line">{</div><div class="line">  <span class="keywordtype">double</span> current_time = parameters.start_time;</div><div class="line">  CDR::WritePVTUOutput pvtu_output(parameters.patch_level);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time_step_n = 0; time_step_n &lt; parameters.n_time_steps;</div><div class="line">       ++time_step_n)</div><div class="line">    {</div><div class="line">      current_time += time_step;</div><div class="line"></div><div class="line">      system_rhs = 0.0;</div><div class="line">      CDR::create_system_rhs&lt;dim&gt;</div><div class="line">      (dof_handler, quad, convection_function, forcing_function, parameters,</div><div class="line">       locally_relevant_solution, constraints, current_time, system_rhs);</div><div class="line">      system_rhs.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line"></div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(dof_handler.n_dofs(),</div><div class="line">                                   1e-6*system_rhs.l2_norm(),</div><div class="line">                                   / *log_history = * / <span class="keyword">false</span>,</div><div class="line">                                   / *log_result = * / <span class="keyword">false</span>);</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1SolverGMRES.html">TrilinosWrappers::SolverGMRES</a> solver(solver_control);</div><div class="line">      solver.solve(system_matrix, completely_distributed_solution, system_rhs,</div><div class="line">                   preconditioner);</div><div class="line">      constraints.distribute(completely_distributed_solution);</div><div class="line">      locally_relevant_solution = completely_distributed_solution;</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (time_step_n % parameters.save_interval == 0)</div><div class="line">        {</div><div class="line">          pvtu_output.write_output(dof_handler, locally_relevant_solution,</div><div class="line">                                   time_step_n, current_time);</div><div class="line">        }</div><div class="line"></div><div class="line">      refine_mesh();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::refine_mesh()</div><div class="line">{</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">  <a class="code" href="classKellyErrorEstimator.html#a971b0bfe57fa21867ed3c06794487e4b">KellyErrorEstimator&lt;dim&gt;::estimate</a></div><div class="line">  (dof_handler, <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1), <span class="keyword">typename</span> <a class="code" href="structFunctionMap.html#a6bb95bc991dd3337330f1c725f59b008">FunctionMap&lt;dim&gt;::type</a>(),</div><div class="line">   locally_relevant_solution, estimated_error_per_cell);</div></div><!-- fragment --><p>This solver uses a crude refinement strategy where cells with relatively high errors are refined and cells with relatively low errors are coarsened. The maximum refinement level is capped to prevent run-away refinement.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : triangulation.<a class="code" href="group__CPP11.html#ga4288670ae5bd80367e24918d542cb2d8">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    <span class="keywordflow">if</span> (std::abs(estimated_error_per_cell[cell-&gt;active_cell_index()]) &gt;= 1e-3)</div><div class="line">      {</div><div class="line">        cell-&gt;set_refine_flag();</div><div class="line">      }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (std::abs(estimated_error_per_cell[cell-&gt;active_cell_index()]) &lt;= 1e-5)</div><div class="line">      {</div><div class="line">        cell-&gt;set_coarsen_flag();</div><div class="line">      }</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (triangulation.<a class="code" href="classTriangulation.html#a777f035a17e91a4d822971516ca11db5">n_levels</a>() &gt; parameters.max_refinement_level)</div><div class="line">  {</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell :</div><div class="line">         triangulation.<a class="code" href="group__CPP11.html#ga27379d62cc1c17e52b4236601b943d0f">cell_iterators_on_level</a>(parameters.max_refinement_level))</div><div class="line">      {</div><div class="line">        cell-&gt;clear_refine_flag();</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Transferring the solution between different grids is ultimately just a few function calls but they must be made in exactly the right order.</p>
<div class="fragment"><div class="line"><a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a></div><div class="line">  solution_transfer(dof_handler);</div><div class="line"></div><div class="line">triangulation.<a class="code" href="classTriangulation.html#ab9fa3177e0e43ab0cf243215d284a35a">prepare_coarsening_and_refinement</a>();</div><div class="line">solution_transfer.prepare_for_coarsening_and_refinement</div><div class="line">  (locally_relevant_solution);</div><div class="line">triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div><div class="line"></div><div class="line">setup_dofs();</div></div><!-- fragment --><p>The <code>solution_transfer</code> object stores a pointer to <code>locally_relevant_solution</code>, so when <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html#aa5cee9bb57e107c609b309184ee5f0a4">parallel::distributed::SolutionTransfer::interpolate</a> is called it uses those values to populate <code>temporary</code>.</p>
<div class="fragment"><div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temporary</div><div class="line">  (locally_owned_dofs, mpi_communicator);</div><div class="line">solution_transfer.interpolate(temporary);</div></div><!-- fragment --><p>After <code>temporary</code> has the correct value, this call correctly populates <code>completely_distributed_solution</code>, which had its index set updated above with the call to <code>setup_dofs</code>.</p>
<div class="fragment"><div class="line">completely_distributed_solution = temporary;</div></div><!-- fragment --><p>Constraints cannot be applied to <a class="el" href="DEALGlossary.html#GlossGhostedVector">vectors with ghost entries</a> since the ghost entries are write only, so this first goes through the completely distributed vector.</p>
<div class="fragment"><div class="line">  constraints.distribute(completely_distributed_solution);</div><div class="line">  locally_relevant_solution = completely_distributed_solution;</div><div class="line">  setup_system();</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> CDRProblem&lt;dim&gt;::run()</div><div class="line">{</div><div class="line">  setup_geometry();</div><div class="line">  setup_dofs();</div><div class="line">  setup_system();</div><div class="line">  time_iterate();</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">constexpr <span class="keywordtype">int</span> dim {2};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div></div><!-- fragment --><p>One of the new features in C++11 is the <code>chrono</code> component of the standard library. This gives us an easy way to time the output.</p>
<div class="fragment"><div class="line">  <span class="keyword">auto</span> t0 = std::chrono::high_resolution_clock::now();</div><div class="line"></div><div class="line">  <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line">  CDR::Parameters parameters;</div><div class="line">  parameters.read_parameter_file(<span class="stringliteral">&quot;parameters.prm&quot;</span>);</div><div class="line">  CDRProblem&lt;dim&gt; cdr_problem(parameters);</div><div class="line">  cdr_problem.run();</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> t1 = std::chrono::high_resolution_clock::now();</div><div class="line">  <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0)</div><div class="line">    {</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;time elapsed: &quot;</span></div><div class="line">                &lt;&lt; std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(t1 - t0).count()</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot; milliseconds.&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
