<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The &#39;Elastoplastic Torsion&#39; code gallery program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2017 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The 'Elastoplastic Torsion' code gallery program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p> 
<p align="center"> 
  This program was contributed by Salvador Flores &lt;sflores@dim.uchile.cl&gt;.
  <br>
  It comes without any warranty or support by its authors or the authors of deal.II.
</p>

</p>
<p>This program is part of the <a class="el" href="CodeGallery.html">deal.II code gallery</a> and consists of the following files (click to inspect):</p><ul>
<li><a href="../code-gallery/ElastoplasticTorsion/CMakeLists.txt">CMakeLists.txt</a></li>
<li><a href="../code-gallery/ElastoplasticTorsion/EPT.prm">EPT.prm</a></li>
<li><a href="../code-gallery/ElastoplasticTorsion/ElastoplasticTorsion.cc">ElastoplasticTorsion.cc</a> (<a href="#ann-ElastoplasticTorsion.cc">annotated version</a>)</li>
<li><a href="../code-gallery/ElastoplasticTorsion/doc/ElastoplasticTorsion-doc.pdf">doc/ElastoplasticTorsion-doc.pdf</a></li>
<li><a href="../code-gallery/ElastoplasticTorsion/doc/entry-name">doc/entry-name</a></li>
</ul>
<p><a class="anchor" id="ann-ElastoplasticTorsion.cc"></a> </p><h1>Annotated version of ElastoplasticTorsion.cc</h1>
<div class="fragment"><div class="line">/ * ---------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Copyright (C) 2010 - 2015 by the deal.II authors</div><div class="line"> *                and Salvador Flores.</div><div class="line"> *</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * This is free software; you can use it, redistribute</div><div class="line"> * it, and/or modify it under the terms of the GNU Lesser General</div><div class="line"> * Public License as published by the Free Software Foundation; either</div><div class="line"> * version 2.1 of the License, or (at your option) any later version.</div><div class="line"> * The full text of the license can be found in the file LICENSE at</div><div class="line"> * the top level of the deal.II distribution.</div><div class="line"> *</div><div class="line"> * ---------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Author: Salvador Flores,</div><div class="line"> *         Center <span class="keywordflow">for</span> Mathematical Modelling,</div><div class="line"> *       Universidad de Chile, 2015.</div><div class="line"> * /</div><div class="line"></div><div class="line"></div><div class="line">/ *</div><div class="line"> This piece of software solves the elliptic p-laplacian</div><div class="line"> boundary-value problems:</div><div class="line"></div><div class="line">   Min {∫ 1/2 W(|Du|²)+ 1/p |Du|^p -fu : u=g on ∂S }   (1)</div><div class="line">    u</div><div class="line"></div><div class="line"> <span class="keywordflow">for</span> large values of p, which approximates (see Alvarez &amp; Flores 2015)</div><div class="line"></div><div class="line">   Min {∫ 1/2 W(|Du|²) -fu : |Du|&lt;1 a.s. on S, u=g on ∂S }</div><div class="line">    u</div><div class="line"></div><div class="line"> By <span class="keywordflow">default</span> W(t)=t and S=unit disk.</div><div class="line"></div><div class="line"> Large portions of <span class="keyword">this</span> code are borrowed from the deal.ii tutorials</div><div class="line"></div><div class="line">      @ref step_15 <span class="stringliteral">&quot;step-15&quot;</span> @ref step_29 <span class="stringliteral">&quot;step-29&quot;</span>.</div><div class="line"></div><div class="line"> For further details see the technical report </div><div class="line"> <span class="stringliteral">&quot;Solving variational problems with uniform gradient bounds by p-Laplacian</span></div><div class="line"><span class="stringliteral">  approximation: Elastoplastic torsion implementation using the deal.II </span></div><div class="line"><span class="stringliteral">  library&quot;</span> </div><div class="line"> available at the documentation and at http:<span class="comment">//www.dim.uchile.cl/~sflores.</span></div><div class="line"></div><div class="line">* /</div></div><!-- fragment --><p>Include files</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/function.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/logstream.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/utilities.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/convergence_table.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/smartpointer.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/parameter_handler.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/base/timer.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/full_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/compressed_sparsity_pattern.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/precondition.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_generator.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_accessor.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_iterator.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_refinement.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_in.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_accessor.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_renumbering.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/matrix_tools.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/error_estimator.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/solution_transfer.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;typeinfo&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/solution_transfer.h&gt;</span></div></div><!-- fragment --><p>Open a namespace for this program and import everything from the dealii namespace into it.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>nsp</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div></div><!-- fragment --><p>******************************************************** //</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ParameterReader : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ParameterReader(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;);</div><div class="line">  <span class="keywordtype">void</span> read_parameters(<span class="keyword">const</span> std::string);</div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> declare_parameters();</div><div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm;</div><div class="line">};</div></div><!-- fragment --><p>Constructor</p>
<div class="fragment"><div class="line">ParameterReader::ParameterReader(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;paramhandler):</div><div class="line">  prm(paramhandler)</div><div class="line">{}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> ParameterReader::declare_parameters()</div><div class="line">{</div><div class="line"></div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Global Parameters&quot;</span>);</div><div class="line">  {</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;p&quot;</span>, <span class="stringliteral">&quot;100&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(2.1),</div><div class="line">                      <span class="stringliteral">&quot;Penalization parameter&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;known_solution&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>,<a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div><div class="line">                      <span class="stringliteral">&quot;Whether the exact solution is known&quot;</span>);</div><div class="line">  }</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line"></div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Mesh &amp; Refinement Parameters&quot;</span>);</div><div class="line">  {</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;Code for the domain&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0,2),</div><div class="line">                      <span class="stringliteral">&quot;Number identifying the domain in which we solve the problem&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;No of initial refinements&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Number of global mesh refinement steps applied to initial coarse grid&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;No of adaptive refinements&quot;</span>, <span class="stringliteral">&quot;8&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Number of global adaptive mesh refinements&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;top_fraction_of_cells&quot;</span>, <span class="stringliteral">&quot;0.25&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;refinement threshold&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;bottom_fraction_of_cells&quot;</span>, <span class="stringliteral">&quot;0.05&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;coarsening threshold&quot;</span>);</div><div class="line">  }</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line"></div><div class="line"></div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Algorithm Parameters&quot;</span>);</div><div class="line">  {</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;Descent_direction&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0,1),</div><div class="line">                      <span class="stringliteral">&quot;0: Preconditioned descent, 1: Newton Method&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;init_p&quot;</span>, <span class="stringliteral">&quot;10&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(2),</div><div class="line">                      <span class="stringliteral">&quot;Initial p&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;delta_p&quot;</span>, <span class="stringliteral">&quot;50&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;increase of p&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;Max_CG_it&quot;</span>, <span class="stringliteral">&quot;1500&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div><div class="line">                      <span class="stringliteral">&quot;Maximum Number of CG iterations&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;CG_tol&quot;</span>, <span class="stringliteral">&quot;1e-10&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Tolerance for CG iterations&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;max_LS_it&quot;</span>, <span class="stringliteral">&quot;45&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div><div class="line">                      <span class="stringliteral">&quot;Maximum Number of LS iterations&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;line_search_tolerence&quot;</span>, <span class="stringliteral">&quot;1e-6&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;line search tolerance constant (c1 in Nocedal-Wright)&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;init_step_length&quot;</span>, <span class="stringliteral">&quot;1e-2&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;initial step length in line-search&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;Max_inner&quot;</span>, <span class="stringliteral">&quot;800&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div><div class="line">                      <span class="stringliteral">&quot;Maximum Number of inner iterations&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;eps&quot;</span>, <span class="stringliteral">&quot;1.0e-8&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Threshold on norm of the derivative to declare optimality achieved&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;hi_eps&quot;</span>, <span class="stringliteral">&quot;1.0e-9&quot;</span>,<a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Threshold on norm of the derivative to declare optimality achieved in highly refined mesh&quot;</span>);</div><div class="line">    prm.<a class="code" href="classParameterHandler.html#afb951f101e0969416f7f47d24c03bcfa">declare_entry</a>(<span class="stringliteral">&quot;hi_th&quot;</span>, <span class="stringliteral">&quot;8&quot;</span>,<a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div><div class="line">                      <span class="stringliteral">&quot;Number of adaptive refinement before change convergence threshold&quot;</span>);</div><div class="line">  }</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line"></div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> ParameterReader::read_parameters (<span class="keyword">const</span> std::string parameter_file)</div><div class="line">{</div><div class="line">  declare_parameters();</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#abc4fe419ccc4b128ec2bad5e0dec62ac">read_input</a> (parameter_file);</div><div class="line">}</div></div><!-- fragment --><p>****************************************************************************************** // The solution of the elastoplastic torsion problem on the unit disk with rhs=4.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  Solution () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#afb9d62ccc1281bc38335c91769d8642d">value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;pto, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const</span>;</div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1,dim&gt;</a> <a class="code" href="classFunction.html#ae0a836ba78787fed039c5a097bdda854">gradient</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;pto, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> Solution&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;pto,<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordtype">double</span> r=sqrt(pto.<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>());</div><div class="line">  <span class="keywordflow">if</span> (r&lt;0.5)</div><div class="line">    <span class="keywordflow">return</span> -1.0*std::pow(r,2.0)+0.75;</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    <span class="keywordflow">return</span> 1.0-r;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1,dim&gt;</a> Solution&lt;dim&gt;::gradient (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;pto,<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordtype">double</span> r=sqrt(pto.<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>());</div><div class="line">  <span class="keywordflow">if</span> (r&lt;0.5)</div><div class="line">    <span class="keywordflow">return</span> -2.0*pto;</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    <span class="keywordflow">return</span>  -1.0*pto/r;</div><div class="line">}</div></div><!-- fragment --><p>****************************************************************************************** //</p>
<div class="fragment"><div class="line">/ *                 Compute the Lagrange multiplier (as a derived quantity)                   * /</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>ComputeMultiplier : <span class="keyword">public</span> <a class="code" href="classDataPostprocessor.html">DataPostprocessor</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">double</span> p;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ComputeMultiplier (<span class="keywordtype">double</span> pe);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="classDataPostprocessor.html#ae6d9f42d2d8acaeab94da23442632796">compute_derived_quantities_scalar</a> (</div><div class="line">    <span class="keyword">const</span> std::vector&lt; double &gt; &amp;,</div><div class="line">    <span class="keyword">const</span> std::vector&lt; <a class="code" href="classTensor.html">Tensor&lt; 1, dim &gt;</a> &gt; &amp;,</div><div class="line">    <span class="keyword">const</span> std::vector&lt; <a class="code" href="classTensor.html">Tensor&lt; 2, dim &gt;</a> &gt; &amp;,</div><div class="line">    <span class="keyword">const</span> std::vector&lt; <a class="code" href="classPoint.html">Point&lt; dim &gt;</a> &gt; &amp;,</div><div class="line">    <span class="keyword">const</span> std::vector&lt; <a class="code" href="classPoint.html">Point&lt; dim &gt;</a> &gt; &amp;,</div><div class="line">    std::vector&lt; <a class="code" href="classVector.html">Vector&lt; double &gt;</a> &gt; &amp;</div><div class="line">  ) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> std::vector&lt;std::string&gt; <a class="code" href="classDataPostprocessor.html#a254f38bcdf4bdb5aa94231b695da7d55">get_names</a> () <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span></div><div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">  <a class="code" href="classDataPostprocessor.html#ae994223acf8a16471ab5e579a4d75053">get_data_component_interpretation</a> () <span class="keyword">const</span>;</div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a> <a class="code" href="classDataPostprocessor.html#aadecdd040447b395164397ea1196f721">get_needed_update_flags</a> () <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">ComputeMultiplier&lt;dim&gt;::ComputeMultiplier (<span class="keywordtype">double</span> pe): p(pe)</div><div class="line">{}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ComputeMultiplier&lt;dim&gt;::compute_derived_quantities_scalar(</div><div class="line">  <span class="keyword">const</span> std::vector&lt; double &gt; &amp;   / *uh* /,</div><div class="line">  <span class="keyword">const</span> std::vector&lt; <a class="code" href="classTensor.html">Tensor&lt; 1, dim &gt;</a> &gt;   &amp;duh,</div><div class="line">  <span class="keyword">const</span> std::vector&lt; <a class="code" href="classTensor.html">Tensor&lt; 2, dim &gt;</a> &gt; &amp;  / *dduh* /,</div><div class="line">  <span class="keyword">const</span> std::vector&lt; <a class="code" href="classPoint.html">Point&lt; dim &gt;</a> &gt; &amp;  / * normals* /,</div><div class="line">  <span class="keyword">const</span> std::vector&lt; <a class="code" href="classPoint.html">Point&lt; dim &gt;</a> &gt; &amp;  / *evaluation_points* /,</div><div class="line">  std::vector&lt; <a class="code" href="classVector.html">Vector&lt; double &gt;</a> &gt;    &amp;computed_quantities )<span class="keyword">   const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_quadrature_points = duh.size();</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q=0; q&lt;n_quadrature_points; ++q)</div><div class="line">    {</div><div class="line">      <span class="keywordtype">long</span>  <span class="keywordtype">double</span> sqrGrad=duh[q]* duh[q]; <span class="comment">//squared norm of the gradient</span></div><div class="line">      <span class="keywordtype">long</span> <span class="keywordtype">double</span> exponent=(p-2.0)/2*std::log(sqrGrad);</div><div class="line">      computed_quantities[q](0) = std::sqrt(sqrGrad); <span class="comment">// norm of the gradient</span></div><div class="line">      computed_quantities[q](1)= std::exp(exponent); <span class="comment">// multiplier</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">std::vector&lt;std::string&gt;</div><div class="line">ComputeMultiplier&lt;dim&gt;::get_names()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  std::vector&lt;std::string&gt; solution_names;</div><div class="line">  solution_names.push_back (<span class="stringliteral">&quot;Gradient norm&quot;</span>);</div><div class="line">  solution_names.push_back (<span class="stringliteral">&quot;Lagrange multiplier&quot;</span>);</div><div class="line">  <span class="keywordflow">return</span> solution_names;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div><div class="line">ComputeMultiplier&lt;dim&gt;::get_needed_update_flags ()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">ComputeMultiplier&lt;dim&gt;:: get_data_component_interpretation ()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">  interpretation;</div></div><!-- fragment --><p>norm of the gradient</p>
<div class="fragment"><div class="line">interpretation.push_back (<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div></div><!-- fragment --><p>Lagrange multiplier</p>
<div class="fragment"><div class="line">  interpretation.push_back (<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line">  <span class="keywordflow">return</span> interpretation;</div><div class="line">}</div></div><!-- fragment --><p>*************************************************************************************** //</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>ElastoplasticTorsion</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ElastoplasticTorsion (<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;);</div><div class="line">  ~ElastoplasticTorsion ();</div><div class="line">  <span class="keywordtype">void</span> run ();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> setup_system (<span class="keyword">const</span> <span class="keywordtype">bool</span> initial_step);</div><div class="line">  <span class="keywordtype">void</span> assemble_system ();</div><div class="line">  <span class="keywordtype">bool</span> solve (<span class="keyword">const</span> <span class="keywordtype">int</span> inner_it);</div><div class="line">  <span class="keywordtype">void</span> init_mesh ();</div><div class="line">  <span class="keywordtype">void</span> refine_mesh ();</div><div class="line">  <span class="keywordtype">void</span> set_boundary_values ();</div><div class="line">  <span class="keywordtype">double</span> phi (<span class="keyword">const</span> <span class="keywordtype">double</span> alpha) <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">bool</span> checkWolfe(<span class="keywordtype">double</span> &amp;alpha, <span class="keywordtype">double</span> &amp;phi_alpha) <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">bool</span> determine_step_length (<span class="keyword">const</span> <span class="keywordtype">int</span> inner_it);</div><div class="line">  <span class="keywordtype">void</span> print_it_message (<span class="keyword">const</span> <span class="keywordtype">int</span> counter, <span class="keywordtype">bool</span> ks);</div><div class="line">  <span class="keywordtype">void</span> output_results (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement) <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">void</span> format_convergence_tables();</div><div class="line">  <span class="keywordtype">void</span> process_solution (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle);</div><div class="line">  <span class="keywordtype">void</span> process_multiplier (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle,<span class="keyword">const</span> <span class="keywordtype">int</span> iter,<span class="keywordtype">double</span> time);</div><div class="line">  <span class="keywordtype">double</span> dual_error () <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">double</span> dual_infty_error () <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">double</span> W (<span class="keywordtype">double</span> Du2) <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">double</span> Wp (<span class="keywordtype">double</span> Du2) <span class="keyword">const</span>;</div><div class="line">  <span class="keywordtype">double</span> G (<span class="keywordtype">double</span> Du2) <span class="keyword">const</span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm;</div><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>   triangulation;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>      dof_handler;</div><div class="line">  <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>     hanging_node_constraints;</div><div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div><div class="line">  <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">  <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> dual_convergence_table;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       present_solution;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       newton_update;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       system_rhs;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       grad_norm;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>        lambda;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> step_length,phi_zero,phi_alpha,phip,phip_zero;</div><div class="line">  <span class="keywordtype">double</span> old_step,old_phi_zero,old_phip;</div><div class="line">  <span class="keywordtype">double</span> L2_error;</div><div class="line">  <span class="keywordtype">double</span> H1_error;</div><div class="line">  <span class="keywordtype">double</span> Linfty_error;</div><div class="line">  <span class="keywordtype">double</span> dual_L1_error;</div><div class="line">  <span class="keywordtype">double</span> dual_L_infty_error;</div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a> fe;</div><div class="line">  <span class="keywordtype">double</span> p;</div><div class="line">  <span class="keywordtype">double</span> line_search_tolerence; <span class="comment">// c_1 in Nocedal &amp; Wright</span></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dir_id;</div><div class="line">  std::string elements;</div><div class="line">  std::string Method;</div><div class="line"></div><div class="line">};</div><div class="line"></div><div class="line">/ ******************************************************************************************* /</div></div><!-- fragment --><p><a class="el" href="classBoundary.html">Boundary</a> condition</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  BoundaryValues () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#afb9d62ccc1281bc38335c91769d8642d">value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;pto,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> / *component* /)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div></div><!-- fragment --><p>could be anything else (theory works provided |Dg|_infty &lt; 1/2)</p>
<div class="fragment"><div class="line">  <span class="keywordflow">return</span> 0.0;</div><div class="line"></div><div class="line">  / * A challenging BC leading to overdetermined problems</div><div class="line">     it is regulated by the parameter 0&lt;eta&lt;1.</div><div class="line">     eta closer to 1 leads to more difficult problems.</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> pii=<a class="code" href="namespacenumbers.html#a5ee2b45bb5bf8e0ab30d95a6afd0a4e8">numbers::PI</a>;</div><div class="line">  <span class="keywordtype">double</span> theta=std::atan2(p[1],p[0])+pii;</div><div class="line">  <span class="keywordtype">double</span> eta=0.9;</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (theta &lt;= 0.5)</div><div class="line">      <span class="keywordflow">return</span> eta*(theta*theta);</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theta &gt;0.5) &amp; (theta&lt;= pii-0.5))</div><div class="line">      <span class="keywordflow">return</span> eta*(theta-0.25);</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theta&gt;pii-0.5)&amp;(theta&lt;= pii+0.5))</div><div class="line">      <span class="keywordflow">return</span> eta*(pii-0.75-(theta-(pii-0.5))*(theta-(pii+0.5)));</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theta&gt;pii+0.5)&amp;(theta&lt;= 2*pii-0.5))</div><div class="line">      <span class="keywordflow">return</span> eta*((2*pii-theta)-0.25);</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">      <span class="keywordflow">return</span> eta*((theta-2*pii)*(theta-2*pii) );* /</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/ ****************************************************************************** /</div></div><!-- fragment --><p>Right-Hand Side</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  RightHandSide () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#afb9d62ccc1281bc38335c91769d8642d">value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> / *component* /)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div></div><!-- fragment --><p>set to constant = 4, for which explicit solution to compare exists could be anything</p>
<div class="fragment"><div class="line">  <span class="keywordtype">double</span> return_value = 4.0;</div><div class="line">  <span class="keywordflow">return</span> return_value;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/ ******************************************************************* /</div></div><!-- fragment --><p>The ElastoplasticTorsion class implementation</p>
<p>Constructor of the class</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">ElastoplasticTorsion&lt;dim&gt;::ElastoplasticTorsion (<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;param):</div><div class="line">  prm(param),</div><div class="line">  dof_handler (triangulation),</div><div class="line">  L2_error(1.0),</div><div class="line">  H1_error(1.0),</div><div class="line">  Linfty_error(1.0),</div><div class="line">  dual_L1_error(1.0),</div><div class="line">  dual_L_infty_error(1.0),</div><div class="line">  fe(2)</div><div class="line">{</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Global Parameters&quot;</span>);</div><div class="line">  p=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;p&quot;</span>);</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Algorithm Parameters&quot;</span>);</div><div class="line">  line_search_tolerence=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;line_search_tolerence&quot;</span>);</div><div class="line">  dir_id=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Descent_direction&quot;</span>);</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">  <span class="keywordflow">if</span> (fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a>==1)</div><div class="line">    elements=<span class="stringliteral">&quot;P1&quot;</span>;</div><div class="line">  <span class="keywordflow">else</span> elements=<span class="stringliteral">&quot;P2&quot;</span>;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (dir_id==0)</div><div class="line">    Method=<span class="stringliteral">&quot;Precond&quot;</span>;</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    Method=<span class="stringliteral">&quot;Newton&quot;</span>;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">ElastoplasticTorsion&lt;dim&gt;::~ElastoplasticTorsion ()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#ad316958f8045d9a48094335b23a03a53">clear</a> ();</div><div class="line">}</div><div class="line"></div><div class="line">/ ***************************************************************************************** /</div></div><!-- fragment --><p>print iteration message</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::print_it_message (<span class="keyword">const</span> <span class="keywordtype">int</span> counter, <span class="keywordtype">bool</span> ks)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (ks)</div><div class="line">    {</div><div class="line">      process_solution (counter);</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;iteration=&quot;</span>&lt;&lt; counter+1 &lt;&lt; <span class="stringliteral">&quot;  J(u_h)= &quot;</span>&lt;&lt; phi_zero &lt;&lt; <span class="stringliteral">&quot;, H1 error: &quot;</span></div><div class="line">                &lt;&lt;  H1_error  &lt;&lt;<span class="stringliteral">&quot;, W0-1,infty error: &quot;</span>&lt;&lt; Linfty_error&lt;&lt; <span class="stringliteral">&quot; J&#39;(u_h)(w)= &quot;</span>&lt;&lt; phip</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;, |J&#39;(u_h)|= &quot;</span>&lt;&lt; system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>()&lt;&lt;std::endl;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;iteration= &quot;</span> &lt;&lt; counter+1 &lt;&lt; <span class="stringliteral">&quot; J(u_h)= &quot;</span></div><div class="line">                &lt;&lt; phi_alpha &lt;&lt; <span class="stringliteral">&quot; J&#39;(u_h)= &quot;</span>&lt;&lt; phip&lt;&lt;std::endl;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ ***************************************************************************************** /</div></div><!-- fragment --><p>Convergence Tables</p>
<div class="fragment"><div class="line">/ ************************************************************* /</div></div><!-- fragment --><p>formating</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::format_convergence_tables()</div><div class="line">{</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;function value&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;derivative&quot;</span>, 3);</div><div class="line">  dual_convergence_table.set_precision(<span class="stringliteral">&quot;dual_L1&quot;</span>, 3);</div><div class="line">  dual_convergence_table.set_precision(<span class="stringliteral">&quot;dual_Linfty&quot;</span>, 3);</div><div class="line">  dual_convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">  dual_convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">  dual_convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;function value&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;derivative&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  dual_convergence_table.set_scientific(<span class="stringliteral">&quot;dual_L1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  dual_convergence_table.set_scientific(<span class="stringliteral">&quot;dual_Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  dual_convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  dual_convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  dual_convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line">/ **************************************** /</div></div><!-- fragment --><p>fill-in entry for the solution</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::process_solution (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> it)</div><div class="line">{</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> difference_per_cell (triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div></div><!-- fragment --><p>compute L2 error (save to difference_per_cell)</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ac092dccd5ef1349dc207353450b58af1">VectorTools::integrate_difference</a> (dof_handler,present_solution,</div><div class="line">                                   Solution&lt;dim&gt;(),difference_per_cell,<a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(3),<a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">L2_error = difference_per_cell.l2_norm();</div></div><!-- fragment --><p>compute H1 error (save to difference_per_cell)</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ac092dccd5ef1349dc207353450b58af1">VectorTools::integrate_difference</a> (dof_handler,present_solution,Solution&lt;dim&gt;(),</div><div class="line">                                   difference_per_cell,<a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(3),<a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">H1_error = difference_per_cell.l2_norm();</div></div><!-- fragment --><p>compute W1infty error (save to difference_per_cell)</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapez.html">QTrapez&lt;1&gt;</a> q_trapez;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated (q_trapez, 5);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#ac092dccd5ef1349dc207353450b58af1">VectorTools::integrate_difference</a> (dof_handler,present_solution,Solution&lt;dim&gt;(),</div><div class="line">                                     difference_per_cell,q_iterated,<a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1af043345075b417b8613b1dd242297418">VectorTools::W1infty_seminorm</a>);</div><div class="line">  Linfty_error = difference_per_cell.linfty_norm();</div><div class="line"></div><div class="line"></div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;cycle&quot;</span>, it);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;p&quot;</span>, p);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;function value&quot;</span>, phi_alpha);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;derivative&quot;</span>, phip);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ *************************************** /</div></div><!-- fragment --><p>fill-in entry for the multiplier</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::process_multiplier (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle, <span class="keyword">const</span> <span class="keywordtype">int</span> iter,<span class="keywordtype">double</span> time)</div><div class="line">{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells=triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs=dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">  dual_L1_error=dual_error();</div><div class="line">  dual_L_infty_error=dual_infty_error();</div><div class="line"></div><div class="line"></div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;cycle&quot;</span>, cycle);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;p&quot;</span>, p);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;iteration_number&quot;</span>, iter);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;cpu_time&quot;</span>, time);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;dual_L1&quot;</span>, dual_L1_error);</div><div class="line">  dual_convergence_table.add_value(<span class="stringliteral">&quot;dual_Linfty&quot;</span>, dual_L_infty_error);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/ **************************************************************************************** /</div></div><!-- fragment --><p>ElastoplasticTorsion::setup_system unchanged from <a class="el" href="step_15.html">step-15</a></p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::setup_system (<span class="keyword">const</span> <span class="keywordtype">bool</span> initial_step)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (initial_step)</div><div class="line">    {</div><div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a> (fe);</div><div class="line">      present_solution.reinit (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">      grad_norm.reinit (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">      lambda.reinit (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line"></div><div class="line">      hanging_node_constraints.clear ();</div><div class="line">      <a class="code" href="group__constraints.html#ga3eaa31a679484e80c193e74e8a967dc8">DoFTools::make_hanging_node_constraints</a> (dof_handler,</div><div class="line">                                               hanging_node_constraints);</div><div class="line">      hanging_node_constraints.close ();</div><div class="line">    }</div></div><!-- fragment --><p>The remaining parts of the function</p>
<div class="fragment"><div class="line">  newton_update.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  CompressedSparsityPattern c_sparsity(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  <a class="code" href="group__constraints.html#ga38d88a1a559e9fc65d60f3e168921ba5">DoFTools::make_sparsity_pattern</a> (dof_handler, c_sparsity);</div><div class="line">  hanging_node_constraints.condense (c_sparsity);</div><div class="line">  sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(c_sparsity);</div><div class="line">  system_matrix.reinit (sparsity_pattern);</div><div class="line">}</div><div class="line"></div><div class="line">/ *************************************************************************************** /</div><div class="line">/ * the coeffcients W, W<span class="stringliteral">&#39; and G defining the problem.</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">   Min_u \int W(|Du|^2) dx</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">They must be consistent as G(s)=W&#39;</span>(s)+2s W<span class="stringliteral">&#39;&#39;</span>(s) <span class="keywordflow">for</span> any s&gt;0.</div><div class="line">recall that they receive the SQUARED gradient. * /</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::W (<span class="keywordtype">double</span> Du2)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> Du2;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::Wp (<span class="keywordtype">double</span> Du2)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> 1.0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::G (<span class="keywordtype">double</span> Du2)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> 1.0;</div><div class="line">}</div><div class="line">/ *************************************************************************************** /</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::assemble_system ()</div><div class="line">{</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(3);</div><div class="line">  <span class="keyword">const</span> RightHandSide&lt;dim&gt; right_hand_side;</div><div class="line">  system_matrix = 0;</div><div class="line">  system_rhs = 0;</div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>         |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>           |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>           cell_matrix (dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>               cell_rhs (dofs_per_cell);</div><div class="line"></div><div class="line">  std::vector&lt;Tensor&lt;1, dim&gt; &gt; old_solution_gradients(n_q_points);</div><div class="line">  std::vector&lt;types::global_dof_index&gt;    local_dof_indices (dofs_per_cell);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div><div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(),</div><div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>();</div><div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div><div class="line">    {</div><div class="line">      cell_matrix = 0;</div><div class="line">      cell_rhs = 0;</div><div class="line"></div><div class="line">      fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a> (cell);</div><div class="line">      fe_values.<a class="code" href="classFEValuesBase.html#aab06de0a7599e39bd417cdc8d5732362">get_function_gradients</a>(present_solution,</div><div class="line">                                       old_solution_gradients);</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div><div class="line">        {</div><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> coeff=0.0;</div><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> a=old_solution_gradients[q_point] * old_solution_gradients[q_point];</div><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> exponent=(p-2.0)/2*std::log(a);</div><div class="line">          coeff= std::exp( exponent);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">if</span> (dir_id==1)</div><div class="line">                    {</div><div class="line">                      cell_matrix(i, j) +=  fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(i, q_point) *  fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q_point)</div><div class="line">                                            * (G(a)+(p-1.0)*coeff)    * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);</div><div class="line">                    }</div><div class="line">                  <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                      cell_matrix(i, j) +=  fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(i, q_point) *  fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(j, q_point)</div><div class="line">                                            * (Wp(a)+coeff)</div><div class="line">                                            * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">              cell_rhs(i) -= (  fe_values.<a class="code" href="classFEValuesBase.html#a07e7840de879ca71f64e6a371e3c66bb">shape_grad</a>(i, q_point)</div><div class="line">                                * old_solution_gradients[q_point]</div><div class="line">                                * (Wp(a)+coeff)</div><div class="line">                                -right_hand_side.value(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point))</div><div class="line">                                *fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_point)</div><div class="line">                             )</div><div class="line">                             * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">      cell-&gt;get_dof_indices (local_dof_indices);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div><div class="line">        {</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div><div class="line">            system_matrix.add (local_dof_indices[i],</div><div class="line">                               local_dof_indices[j],</div><div class="line">                               cell_matrix(i,j));</div><div class="line"></div><div class="line">          system_rhs(local_dof_indices[i]) += cell_rhs(i);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">  hanging_node_constraints.condense (system_matrix);</div><div class="line">  hanging_node_constraints.condense (system_rhs);</div><div class="line"></div><div class="line">  std::map&lt;types::global_dof_index,double&gt; boundary_values;</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (dof_handler,</div><div class="line">                                            0,</div><div class="line">                                            <a class="code" href="classZeroFunction.html">ZeroFunction&lt;dim&gt;</a>(),</div><div class="line">                                            boundary_values);</div><div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a> (boundary_values,</div><div class="line">                                      system_matrix,</div><div class="line">                                      newton_update,</div><div class="line">                                      system_rhs);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/ **********************************      Refine Mesh      **************************************** /</div></div><!-- fragment --><p>unchanged from <a class="el" href="step_15.html">step-15</a></p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::refine_mesh ()</div><div class="line">{</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell (triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">  <a class="code" href="classKellyErrorEstimator.html#a971b0bfe57fa21867ed3c06794487e4b">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim-1&gt;</a>(3),</div><div class="line">                                      <span class="keyword">typename</span> <a class="code" href="structFunctionMap.html#a6bb95bc991dd3337330f1c725f59b008">FunctionMap&lt;dim&gt;::type</a>(),</div><div class="line">                                      present_solution,</div><div class="line">                                      estimated_error_per_cell);</div><div class="line"></div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Mesh &amp; Refinement Parameters&quot;</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> top_fraction=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;top_fraction_of_cells&quot;</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> bottom_fraction=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;bottom_fraction_of_cells&quot;</span>);</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">  <a class="code" href="namespaceGridRefinement.html#a2500638aae40fe3bfbf094754645dc57">GridRefinement::refine_and_coarsen_fixed_number</a> (triangulation,</div><div class="line">                                                   estimated_error_per_cell,</div><div class="line">                                                   top_fraction, bottom_fraction);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#ab9fa3177e0e43ab0cf243215d284a35a">prepare_coarsening_and_refinement</a> ();</div><div class="line">  <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim&gt;</a> solution_transfer(dof_handler);</div><div class="line">  solution_transfer.prepare_for_coarsening_and_refinement(present_solution);</div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  solution_transfer.interpolate(present_solution, tmp);</div><div class="line">  present_solution = tmp;</div><div class="line">  set_boundary_values ();</div><div class="line">  hanging_node_constraints.clear();</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#ga3eaa31a679484e80c193e74e8a967dc8">DoFTools::make_hanging_node_constraints</a>(dof_handler,</div><div class="line">                                          hanging_node_constraints);</div><div class="line">  hanging_node_constraints.close();</div><div class="line">  hanging_node_constraints.distribute (present_solution);</div><div class="line">  setup_system (<span class="keyword">false</span>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ ******************************************************************************************* /</div></div><!-- fragment --><p>Dump the norm of the gradient and the lagrange multiplier in vtu format for visualization</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::output_results (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> counter)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div></div><!-- fragment --><p>multiplier object contains both |Du| and lambda.</p>
<div class="fragment"><div class="line">  ComputeMultiplier&lt;dim&gt; multiplier(p);</div><div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a> (dof_handler);</div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a> (present_solution, <span class="stringliteral">&quot;solution&quot;</span>);</div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a> (present_solution, multiplier);</div><div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a> ();</div><div class="line">  std::ostringstream p_str;</div><div class="line">  p_str &lt;&lt; p&lt;&lt;<span class="stringliteral">&quot;-cycle-&quot;</span>&lt;&lt;counter;</div><div class="line">  std::string str = p_str.str();</div><div class="line">  <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution-&quot;</span> + str+<span class="stringliteral">&quot;.vtu&quot;</span>;</div><div class="line">  std::ofstream output (filename.c_str());</div><div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a> (output);</div><div class="line">}</div><div class="line"></div><div class="line">/ ******************************************************************************************** /</div></div><!-- fragment --><p>unchanged from <a class="el" href="step_15.html">step-15</a></p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::set_boundary_values ()</div><div class="line">{</div><div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a187aeb575be07bc47cb3dea1a47aaf88">VectorTools::interpolate_boundary_values</a> (dof_handler,</div><div class="line">                                            0,</div><div class="line">                                            BoundaryValues&lt;dim&gt;(),</div><div class="line">                                            boundary_values);</div><div class="line">  <span class="keywordflow">for</span> (std::map&lt;types::global_dof_index, double&gt;::const_iterator</div><div class="line">       bp = boundary_values.begin();</div><div class="line">       bp != boundary_values.end(); ++bp)</div><div class="line">    present_solution(bp-&gt;first) = bp-&gt;second;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ **************************************************************************************** /</div></div><!-- fragment --><p>COMPUTE ()=J_p(u_h+ w)</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::phi (<span class="keyword">const</span> <span class="keywordtype">double</span> alpha)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordtype">double</span> obj = 0.0;</div><div class="line">  <span class="keyword">const</span> RightHandSide&lt;dim&gt; right_hand_side;</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> evaluation_point (dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  evaluation_point = present_solution;  <span class="comment">// copy of u_h</span></div><div class="line">  evaluation_point.<a class="code" href="classVector.html#a10b0336c485e36c7b4b105dd2a926002">add</a> (alpha, newton_update); <span class="comment">// u_{n+1}=u_n+alpha w_n</span></div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(3);</div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>         |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>               <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> (dofs_per_cell);</div><div class="line">  std::vector&lt;Tensor&lt;1, dim&gt; &gt; gradients(n_q_points);</div><div class="line">  std::vector&lt;double&gt; values(n_q_points);</div><div class="line"></div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt;    local_dof_indices (dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div><div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(),</div><div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>();</div><div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div><div class="line">    {</div><div class="line">      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> = 0;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a> (cell);</div><div class="line">      fe_values.<a class="code" href="classFEValuesBase.html#aab06de0a7599e39bd417cdc8d5732362">get_function_gradients</a> (evaluation_point, gradients);</div><div class="line">      fe_values.<a class="code" href="classFEValuesBase.html#a357b422e374f2f2207af3512093f3907">get_function_values</a> (evaluation_point, values);</div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div><div class="line">        {</div><div class="line">          <span class="keywordtype">double</span> Du2=gradients[q_point] *  gradients[q_point]; <span class="comment">// Du2=|Du|^2</span></div><div class="line">          <span class="keywordtype">double</span> penalty;</div><div class="line">          <span class="keywordflow">if</span> (Du2&lt;1.0e-10)</div><div class="line">            penalty=0.0;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            penalty=std::pow(Du2,p/2.0); <span class="comment">// penalty=|Du|^p</span></div></div><!-- fragment --><p>obj+= 1/2 W(|Du|^2)+1/p |Du|^p -fu (see (1))</p>
<div class="fragment"><div class="line">          obj+=(</div><div class="line">                 (0.5*W(Du2)+penalty/p)- right_hand_side.value(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point))*values[q_point]</div><div class="line">               ) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> obj;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ *************************************************************************************************** /</div></div><!-- fragment --><p>Compute L^1 error norm of Lagrange Multiplier with respect to exact solution (cf. Alvarez &amp; Flores, 2015)</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::dual_error ()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordtype">double</span> obj = 0.0;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(3);</div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>         |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>               <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> (dofs_per_cell);</div><div class="line">  std::vector&lt;Tensor&lt;1, dim&gt; &gt; gradients(n_q_points);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt;    local_dof_indices (dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div><div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(),</div><div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>();</div><div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div><div class="line">    {</div><div class="line">      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> = 0;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a> (cell);</div><div class="line">      fe_values.<a class="code" href="classFEValuesBase.html#aab06de0a7599e39bd417cdc8d5732362">get_function_gradients</a> (present_solution, gradients);</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div><div class="line">        {</div><div class="line">          <span class="keywordtype">double</span> coeff=gradients[q_point] *  gradients[q_point] ;</div><div class="line">          <span class="keywordflow">if</span> (coeff&lt;1.0e-15)</div><div class="line">            coeff=0.0;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coeff=std::pow(coeff,(p-2.0)/2.0); <span class="comment">// |Du_p|^(p-2)</span></div><div class="line"></div><div class="line">          <span class="keywordtype">double</span> r=std::sqrt(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>());</div><div class="line">          <span class="keywordtype">double</span> exact=0;</div><div class="line">          <span class="keywordflow">if</span> (r&gt;0.5)</div><div class="line">            exact= 2*r-1;</div><div class="line"></div><div class="line">          obj+=(     std::abs(coeff-exact) ) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> obj;</div><div class="line">}</div><div class="line"></div><div class="line">/ ******************************************************************************************* /</div></div><!-- fragment --><p>Compute L^infinity error norm of Lagrange Multiplier with respect to exact solution (cf. Alvarez &amp; Flores, 2015)</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> ElastoplasticTorsion&lt;dim&gt;::dual_infty_error ()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordtype">double</span> obj = 0.0;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapez.html">QTrapez&lt;1&gt;</a> q_trapez;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula (q_trapez, 10);</div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>         |</div><div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> );</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>               <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> (dofs_per_cell);</div><div class="line">  std::vector&lt;Tensor&lt;1, dim&gt; &gt; gradients(n_q_points);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt;    local_dof_indices (dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div><div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(),</div><div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>();</div><div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div><div class="line">    {</div><div class="line">      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#ac21c42d71eba9418a5852d8b5b5a4e0e">cell_residual</a> = 0;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#aec8f5b8b3e4c5dcf35dfd029a1ecbbd0">reinit</a> (cell);</div><div class="line">      fe_values.<a class="code" href="classFEValuesBase.html#aab06de0a7599e39bd417cdc8d5732362">get_function_gradients</a> (present_solution, gradients);</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div><div class="line">        {</div><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> sqdGrad=gradients[q_point] *  gradients[q_point] ;</div><div class="line">          <span class="keywordtype">double</span> r=std::sqrt(fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>());</div><div class="line">          <span class="keywordtype">double</span> exact=0;</div><div class="line">          <span class="keywordflow">if</span> (r&gt;0.5)</div><div class="line">            exact= 2*r-1.0;</div></div><!-- fragment --><p>compute |Du|^(p-2) as exp(p-2/2*log(Du^2))</p>
<div class="fragment"><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> exponent=(p-2.0)/2*std::log(sqdGrad);</div><div class="line">          <span class="keywordtype">long</span> <span class="keywordtype">double</span> coeff=std::exp(exponent);</div><div class="line"></div><div class="line">          <span class="keywordflow">if</span> (std::abs(coeff-exact)&gt;obj )</div><div class="line">            obj=std::abs(coeff-exact);</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> obj;</div><div class="line">}</div><div class="line"></div><div class="line">/ ***************************************************************************************** /</div></div><!-- fragment --><p>check whether putative step-length satisfies sufficient decrease conditions</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">bool</span> ElastoplasticTorsion&lt;dim&gt;::checkWolfe(<span class="keywordtype">double</span> &amp;alpha, <span class="keywordtype">double</span> &amp;phi_alpha)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">if</span> (phi_alpha&lt; phi_zero+line_search_tolerence*phip*alpha )</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/ ***************************************************************************************** /</div></div><!-- fragment --><p>Find a step-length satisfying sufficient decrease condition by line-search uses quadratic interpolation</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">bool</span> ElastoplasticTorsion&lt;dim&gt;::determine_step_length(<span class="keyword">const</span> <span class="keywordtype">int</span> inner_it)</div><div class="line">{</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> it=0;</div><div class="line">  <span class="keywordtype">bool</span> done;</div><div class="line">  <span class="keywordtype">double</span> alpha,nalpha;</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Algorithm Parameters&quot;</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_LS_it=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;max_LS_it&quot;</span>);</div><div class="line">  <span class="keywordtype">double</span> init_SL=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;init_step_length&quot;</span>);</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">  <span class="keywordflow">if</span> (inner_it==0)</div><div class="line">    alpha=init_SL;</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">      alpha=std::min(1.45*old_step*old_phip/phip,1.0);</div><div class="line">    }</div><div class="line">  phi_alpha=phi(alpha);</div><div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;Step length=&quot;</span> &lt;&lt; alpha &lt;&lt; <span class="stringliteral">&quot;, Value= &quot;</span> &lt;&lt; phi_alpha;</div></div><!-- fragment --><p>check if step-size satisfies sufficient decrease condition</p>
<div class="fragment"><div class="line">done=checkWolfe(alpha,phi_alpha);</div><div class="line"><span class="keywordflow">if</span> (done)</div><div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot; accepted&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="keywordflow">else</span></div><div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot; rejected&quot;</span> ;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> ((!done) &amp; (it&lt;max_LS_it))</div><div class="line">  {</div></div><!-- fragment --><p>new try obtained by quadratic interpolation</p>
<div class="fragment"><div class="line">      nalpha=-(phip*alpha*alpha)/(2*(phi_alpha-phi_zero-phip*alpha));</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (nalpha&lt;1e-3*alpha ||  std::abs(nalpha-alpha)/alpha&lt;1e-8)</div><div class="line">        nalpha=alpha/2;</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( phi_alpha-phi_zero&gt;1e3*std::abs(phi_zero) )</div><div class="line">        nalpha=alpha/10;</div><div class="line">      alpha=nalpha;</div><div class="line">      phi_alpha=phi(alpha);</div><div class="line">      done=checkWolfe(alpha,phi_alpha);</div><div class="line">      <span class="keywordflow">if</span> (done)</div><div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;, finished with steplength= &quot;</span>&lt;&lt; alpha&lt;&lt; <span class="stringliteral">&quot;, fcn value= &quot;</span>&lt;&lt; phi_alpha&lt;&lt;std::endl;</div><div class="line">      it=it+1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">if</span> (!done)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;, max. no. of iterations reached wiht steplength= &quot;</span>&lt;&lt; alpha</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;, fcn value= &quot;</span>&lt;&lt; phi_alpha&lt;&lt;std::endl;</div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">      step_length=alpha;</div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line">/ ************************************************************************************************** /</div></div><!-- fragment --><p>ElastoplasticTorsion::init_mesh()</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::init_mesh ()</div><div class="line">{</div></div><!-- fragment --><p>get parameters</p>
<div class="fragment"><div class="line">prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Mesh &amp; Refinement Parameters&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> domain_id=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Code for the domain&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> init_ref=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;No of initial refinements&quot;</span>);</div><div class="line">prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (domain_id==0)</div><div class="line">  {</div></div><!-- fragment --><p>For the unit disk around the origin</p>
<div class="fragment"><div class="line">    <a class="code" href="namespaceGridGenerator.html#a0a81f736ef95164a9d9bf0f844ac682b">GridGenerator::hyper_ball</a> (triangulation);</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classHyperBallBoundary.html">HyperBallBoundary&lt;dim&gt;</a> boundary;</div><div class="line">    triangulation.<a class="code" href="group__boundary.html#ga19accbef5edb5bb16a926d3db659cd5c">set_boundary</a> (0, boundary);</div><div class="line">  }</div><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (domain_id==1)</div><div class="line">  {</div></div><!-- fragment --><p>For the unit square</p>
<div class="fragment"><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a> (triangulation, 0, 1);</div><div class="line">  }</div><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (domain_id==2)</div><div class="line">  {</div><div class="line">    / * For Glowinski<span class="stringliteral">&#39;s domain</span></div><div class="line"><span class="stringliteral">        ___    ___   __ 1</span></div><div class="line"><span class="stringliteral">       |   |__|   |  __ .8</span></div><div class="line"><span class="stringliteral">     |          |</span></div><div class="line"><span class="stringliteral">     |          |</span></div><div class="line"><span class="stringliteral">     |__________|  __ 0</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">       |   |  |   |</span></div><div class="line"><span class="stringliteral">       0  .4 .6   1</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    * /</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria1;</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria2;</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria3;</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria4;</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria5;</span></div><div class="line"><span class="stringliteral">    Triangulation&lt;dim&gt; tria6;</span></div><div class="line"><span class="stringliteral">    GridGenerator::hyper_rectangle(tria1, Point&lt;2&gt;(0.0,0.0), Point&lt;2&gt;(0.4,0.8));</span></div><div class="line"><span class="stringliteral">    GridGenerator::hyper_rectangle(tria2, Point&lt;2&gt;(0.0,0.8), Point&lt;2&gt;(0.4,1.0));</span></div><div class="line"><span class="stringliteral">    GridGenerator::hyper_rectangle(tria3, Point&lt;2&gt;(0.4,0.0), Point&lt;2&gt;(0.6,0.8));</span></div><div class="line"><span class="stringliteral">    GridGenerator::hyper_rectangle(tria4, Point&lt;2&gt;(0.6,0.0), Point&lt;2&gt;(1.0,0.8));</span></div><div class="line"><span class="stringliteral">    GridGenerator::hyper_rectangle(tria5, Point&lt;2&gt;(0.6,0.8), Point&lt;2&gt;(1.0,1.0));</span></div><div class="line"><span class="stringliteral">    GridGenerator::merge_triangulations (tria1, tria2, tria6);</span></div><div class="line"><span class="stringliteral">    GridGenerator::merge_triangulations (tria6, tria3, tria6);</span></div><div class="line"><span class="stringliteral">    GridGenerator::merge_triangulations (tria6, tria4, tria6);</span></div><div class="line"><span class="stringliteral">    GridGenerator::merge_triangulations (tria6, tria5, triangulation);</span></div><div class="line"><span class="stringliteral">  }</span></div></div><!-- fragment --><p>perform initial refinements</p>
<div class="fragment"><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(init_ref);</div><div class="line">}</div><div class="line"></div><div class="line">/ ************************************************************************************************** /</div></div><!-- fragment --><p>ElastoplasticTorsion::solve(inner_it) Performs one inner iteration</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">bool</span> ElastoplasticTorsion&lt;dim&gt;::solve (<span class="keyword">const</span> <span class="keywordtype">int</span> inner_it)</div><div class="line">{</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Algorithm Parameters&quot;</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_CG_it=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Max_CG_it&quot;</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> CG_tol=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;CG_tol&quot;</span>);</div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line"></div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control (max_CG_it,CG_tol);</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;&gt;</a>    solver (solver_control);</div><div class="line"></div><div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix,0.25);</div><div class="line"></div><div class="line">  solver.solve (system_matrix, newton_update, system_rhs,</div><div class="line">                preconditioner);</div><div class="line">  hanging_node_constraints.distribute (newton_update);</div><div class="line">  / ******  save current quantities <span class="keywordflow">for</span> line-search  **** * /</div></div><!-- fragment --><p>Recall that phi(alpha)=J(u+alpha w)</p>
<div class="fragment"><div class="line">old_step=step_length;</div><div class="line">old_phi_zero=phi_zero;</div><div class="line">phi_zero=phi(0); <span class="comment">// phi(0)=J(u)</span></div><div class="line">old_phip=phip;</div><div class="line">phip=-1.0*(newton_update*system_rhs); <span class="comment">//phi&#39;(0)=J&#39;(u) *w, rhs=-J&#39;(u).</span></div><div class="line"><span class="keywordflow">if</span> (inner_it==0)</div><div class="line">  phip_zero=phip;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (phip&gt;0)   <span class="comment">// this should not happen, step back</span></div><div class="line">  {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Not a descent direction!&quot;</span> &lt;&lt;std::endl;</div><div class="line">    present_solution.add (-1.0*step_length, newton_update);</div><div class="line">    step_length=step_length/2;</div><div class="line">    phip=old_phip;</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">  }</div><div class="line"><span class="keywordflow">else</span></div><div class="line">  {</div><div class="line">    <span class="keywordflow">if</span> (determine_step_length(inner_it))</div><div class="line">      {</div></div><!-- fragment --><p>update u_{n+1}=u_n+alpha w_n</p>
<div class="fragment"><div class="line">          present_solution.add (step_length, newton_update);</div><div class="line">          <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/ ************************************************************************************************************* /</div></div><!-- fragment --><p>ElastoplasticTorsion::run</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ElastoplasticTorsion&lt;dim&gt;::run ()</div><div class="line">{</div></div><!-- fragment --><p>get parameters</p>
<div class="fragment"><div class="line">prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Mesh &amp; Refinement Parameters&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> adapt_ref=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;No of adaptive refinements&quot;</span>);</div><div class="line">prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Algorithm Parameters&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> max_inner=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Max_inner&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> eps=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;eps&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> hi_eps=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;hi_eps&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> hi_th=prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;hi_th&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> init_p=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;init_p&quot;</span>);</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> delta_p=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;delta_p&quot;</span>);</div><div class="line">prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a> (<span class="stringliteral">&quot;Global Parameters&quot;</span>);</div><div class="line"><span class="keywordtype">bool</span> known_solution=prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;known_solution&quot;</span>);</div><div class="line"><span class="keywordtype">double</span> actual_p=prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;p&quot;</span>);</div><div class="line">prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a> ();</div><div class="line">/ ************************ /</div></div><!-- fragment --><p>init <a class="el" href="classTimer.html">Timer</a></p>
<div class="fragment"><div class="line"><a class="code" href="classTimer.html">Timer</a> timer;</div><div class="line"><span class="keywordtype">double</span> ptime=0.0;</div><div class="line">timer.<a class="code" href="classTimer.html#a3a8b5272198d029779dc9302a54305a8">start</a> ();</div></div><!-- fragment --><p>initalize mesh for the selected domain</p>
<div class="fragment"><div class="line">init_mesh();</div></div><!-- fragment --><p>setup FE space</p>
<div class="fragment"><div class="line">setup_system (<span class="keyword">true</span>);</div><div class="line">set_boundary_values ();</div></div><!-- fragment --><p>init counters</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> global_it=0;    <span class="comment">// Total inner iterations (counting both loops)</span></div><div class="line"><span class="keywordtype">int</span> cycle=0;          <span class="comment">// Total outer iterations (counting both loops)</span></div><div class="line"><span class="keywordtype">int</span> refinement = 0;    <span class="comment">//  Refinements  performed (adaptive) = outer iterations 2nd loop</span></div></div><!-- fragment --><p>prepare to start first loop</p>
<div class="fragment"><div class="line">p=init_p;</div><div class="line"><span class="keywordtype">bool</span> well_solved=<span class="keyword">true</span>;</div><div class="line"></div><div class="line">/ *****************************          First <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a>      *********************************** /</div><div class="line">/ ****************** Prepare <a class="code" href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">initial</a> condition <span class="keyword">using</span> increasing p  ************************* /</div><div class="line"><span class="keywordflow">while</span> (p&lt;actual_p) <span class="comment">// outer iteration, increasing p.</span></div><div class="line">  {</div><div class="line">    std::cout &lt;&lt;<span class="stringliteral">&quot;--Preparing initial condition with p=&quot;</span>&lt;&lt;p&lt;&lt;<span class="stringliteral">&quot; iter.= &quot;</span> &lt;&lt; global_it&lt;&lt;  <span class="stringliteral">&quot;  .-- &quot;</span>&lt;&lt; std::endl;</div><div class="line">    timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> inner_iteration=0; inner_iteration&lt;max_inner; ++inner_iteration,++global_it)</div><div class="line">      {</div><div class="line">        assemble_system ();</div><div class="line">        well_solved=solve (inner_iteration);</div><div class="line">        print_it_message (global_it, known_solution);</div><div class="line">        <span class="keywordflow">if</span> (</div><div class="line">          ((system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>()/std::sqrt(system_rhs.<a class="code" href="classBlockVectorBase.html#a69b8dc1f71903659eb44f12e02359ac6">size</a>()) &lt;1e-4) &amp; (cycle&lt;1)) |</div><div class="line">          ((system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>()/std::sqrt(system_rhs.<a class="code" href="classBlockVectorBase.html#a69b8dc1f71903659eb44f12e02359ac6">size</a>()) &lt;1e-5) &amp; (cycle&gt;=1)) |</div><div class="line">          !well_solved</div><div class="line">        )</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">    ptime=timer();</div><div class="line">    <span class="keywordflow">if</span> (well_solved)</div><div class="line">      output_results (cycle);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (known_solution)</div><div class="line">      {</div><div class="line">        process_multiplier(cycle,global_it,ptime);</div></div><!-- fragment --><p>dual_convergence_table.write_tex(dual_error_table_file);</p>
<div class="fragment"><div class="line">      }</div><div class="line">    refine_mesh();</div><div class="line">    cycle++;</div><div class="line">    p+=delta_p;</div><div class="line">  }</div><div class="line">/ ***************************    first <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> finished        ******************** /</div></div><!-- fragment --><p>prepare for second loop</p>
<div class="fragment"><div class="line">p=actual_p;</div><div class="line">well_solved=<span class="keyword">true</span>;</div><div class="line"></div><div class="line"></div><div class="line">/ *****************************        Second <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a>         ********************************* /</div><div class="line">/ **************************** Solve problem <span class="keywordflow">for</span> target p  ********************************* /</div><div class="line"></div><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;============ Solving  problem with p=&quot;</span>   &lt;&lt;p &lt;&lt; <span class="stringliteral">&quot; ==================&quot;</span>  &lt;&lt; std::endl;</div><div class="line">/ *****    Outer iteration - refining mesh  ****************** /</div><div class="line"><span class="keywordflow">while</span> ((cycle&lt;adapt_ref) &amp; well_solved)</div><div class="line">  {</div><div class="line">    timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div></div><!-- fragment --><p>inner iteration</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> inner_iteration=0; inner_iteration&lt;max_inner; ++inner_iteration,++global_it)</div><div class="line">  {</div><div class="line">    assemble_system ();</div><div class="line">    well_solved=solve (inner_iteration);</div><div class="line">    print_it_message (global_it, known_solution);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (</div><div class="line">      ((system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>()/std::sqrt(system_rhs.<a class="code" href="classBlockVectorBase.html#a69b8dc1f71903659eb44f12e02359ac6">size</a>()) &lt; eps) &amp; (refinement&lt;hi_th)) |</div><div class="line">      (( system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>()/ std::sqrt (system_rhs.<a class="code" href="classBlockVectorBase.html#a69b8dc1f71903659eb44f12e02359ac6">size</a>()) &lt;hi_eps)  | (!well_solved))</div><div class="line">    )</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">  }</div></div><!-- fragment --><p>inner iterations finished</p>
<div class="fragment"><div class="line">ptime=timer();</div><div class="line"><span class="keywordflow">if</span> (well_solved)</div><div class="line">  output_results (cycle);</div></div><!-- fragment --><p>compute and display error, if the explicit solution is known</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (known_solution)</div><div class="line">  {</div><div class="line">    process_multiplier(cycle,global_it,ptime);</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;finished with H1 error: &quot;</span> &lt;&lt;  H1_error &lt;&lt; <span class="stringliteral">&quot;, dual error (L1): &quot;</span></div><div class="line">              &lt;&lt; dual_L1_error &lt;&lt; <span class="stringliteral">&quot;dual error (L infty): &quot;</span>&lt;&lt;dual_L_infty_error &lt;&lt;std::endl;</div><div class="line">  }</div></div><!-- fragment --><p>update counters</p>
<div class="fragment"><div class="line">++refinement;</div><div class="line">++cycle;</div></div><!-- fragment --><p>refine mesh</p>
<div class="fragment"><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;******** Refined mesh &quot;</span> &lt;&lt; cycle    &lt;&lt; <span class="stringliteral">&quot; ********&quot;</span>  &lt;&lt; std::endl;</div><div class="line">  refine_mesh();</div><div class="line">}<span class="comment">// second loop</span></div></div><!-- fragment --><p>write convergence tables to file</p>
<div class="fragment"><div class="line">    <span class="keywordflow">if</span> (known_solution)</div><div class="line">      {</div><div class="line">        format_convergence_tables();</div><div class="line">        std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>+Method+elements+<span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">        std::ofstream error_table_file(error_filename.c_str());</div><div class="line">        std::string dual_error_filename = <span class="stringliteral">&quot;dual_error&quot;</span>+Method+elements+<span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">        std::ofstream dual_error_table_file(dual_error_filename.c_str());</div><div class="line">        convergence_table.write_tex(error_table_file);</div><div class="line">        dual_convergence_table.write_tex(dual_error_table_file);</div><div class="line">      }</div><div class="line">  }<span class="comment">//run()</span></div><div class="line"></div><div class="line">}<span class="comment">//namespace</span></div><div class="line"></div><div class="line">/ ********************************************************************************************** /</div></div><!-- fragment --><p>The main function</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main ()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>nsp;</div><div class="line">      deallog.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a> (0);</div><div class="line"></div><div class="line">      <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm;</div><div class="line">      ParameterReader param(prm);</div><div class="line">      param.read_parameters(<span class="stringliteral">&quot;EPT.prm&quot;</span>);</div><div class="line">      ElastoplasticTorsion&lt;2&gt; ElastoplasticTorsionProblem(prm);</div><div class="line">      ElastoplasticTorsionProblem .run ();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span>    &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
